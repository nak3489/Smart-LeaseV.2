<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบบริหารสัญญาเช่าตึกสำนักงาน</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
        body { box-sizing: border-box; font-family: 'Kanit', sans-serif; }
        * { font-family: 'Kanit', sans-serif; }
        .sidebar-menu-item { transition: all 0.3s ease; }
        .sidebar-menu-item:hover { background-color: #AED581; transform: translateX(5px); }
        .sidebar-menu-item.active { background-color: #AED581; }
        .card-hover { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .toast { position: fixed; top: 20px; right: 20px; background: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .badge-active { background-color: #AED581; color: #2E7D32; }
        .badge-expiring { background-color: #FFCA28; color: #F57F17; }
        .badge-expired { background-color: #EF5350; color: white; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: #26A69A; color: white; padding: 12px; text-align: left; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #e0e0e0; }
        tr:hover { background-color: #f5f5f5; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9998; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 24px; border-radius: 16px; max-width: 600px; width: 90%; max-height: 90%; overflow-y: auto; }
        .loader {
          transform: translateZ(1px);
        }
        .loader:after {
          content: '$';
          display: inline-block;
          width: 48px;
          height: 48px;
          border-radius: 50%;
          text-align: center;
          line-height:40px;
          font-size: 32px;
          font-weight: bold;
          background: #FFD700;
          color: #DAA520;
          border: 4px double ;
          box-sizing: border-box;
          box-shadow:  2px 2px 2px 1px rgba(0, 0, 0, .1);
          animation: coin-flip 4s cubic-bezier(0, 0.2, 0.8, 1) infinite;
        }
        @keyframes coin-flip {
          0%, 100% {
            animation-timing-function: cubic-bezier(0.5, 0, 1, 0.5);
          }
          0% {
            transform: rotateY(0deg);
          }
          50% {
            transform: rotateY(1800deg);
            animation-timing-function: cubic-bezier(0, 0.5, 0.5, 1);
          }
          100% {
            transform: rotateY(3600deg);
          }
        }
        .file-preview-item {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .file-preview-item img, .file-preview-item a {
            display: block;
            width: 100%;
            height: 100px;
        }
        .file-preview-item img {
            object-fit: cover;
        }
        .file-preview-item .remove-file-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: rgba(239, 68, 68, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            line-height: 1;
            transition: background-color 0.2s;
        }
        .file-preview-item .remove-file-btn:hover {
            background-color: rgb(220, 38, 38);
        }

        @keyframes pageFadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-page-load {
            animation: pageFadeInUp 0.6s ease-out forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-login-card {
            animation: fadeIn 0.7s ease-out;
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in {
            animation: slideInUp 0.6s ease-out forwards;
            opacity: 0;
        }
  </style>
 </head>
 <body class="bg-gray-100">
  <div id="toastContainer"></div>
  <div id="loginPage" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-teal-400 to-green-400">
   <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md animate-login-card">
    <div class="text-center mb-8 animate-slide-in" style="animation-delay: 0.1s;">
        <i class="fas fa-file-contract text-6xl text-teal-500 mb-4"></i>
        <h1 class="text-3xl font-bold text-gray-800">ระบบบริหารสัญญาเช่า</h1>
        <p class="text-gray-600 mt-2">เข้าสู่ระบบเพื่อดำเนินการต่อ</p>
    </div>
    <form id="loginForm" class="space-y-4">
     <div class="animate-slide-in" style="animation-delay: 0.2s;">
        <label for="username" class="block text-sm font-medium text-gray-700 mb-2">ชื่อผู้ใช้</label> 
        <input type="text" id="username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="กรอกชื่อผู้ใช้">
     </div>
     <div class="animate-slide-in" style="animation-delay: 0.3s;">
        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">รหัสผ่าน</label> 
        <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="กรอกรหัสผ่าน">
     </div>
     <button type="submit" class="w-full bg-teal-500 text-white py-3 rounded-lg font-semibold hover:bg-teal-600 transition duration-300 animate-slide-in" style="animation-delay: 0.4s;"> 
        <i class="fas fa-sign-in-alt mr-2"></i>เข้าสู่ระบบ 
     </button>
    </form>
   </div>
  </div>
  <div id="mainApp" class="hidden">
   <div class="fixed top-4 right-4 z-50 flex items-center space-x-4">
    
    <button id="sidebarToggleMobile" class="md:hidden bg-white rounded-full p-3 shadow-lg hover:shadow-xl hover:bg-teal-50 transition duration-300" title="เปิด/ปิดเมนู">
        <i class="fas fa-bars text-xl text-teal-500"></i>
    </button>

    <button id="refreshDataBtn" class="bg-white rounded-full p-3 shadow-lg hover:shadow-xl hover:bg-teal-50 transition duration-300" title="รีเฟรชข้อมูลหน้านี้"> 
        <i class="fas fa-sync-alt text-xl text-teal-500"></i> 
    </button>
    
    <button id="notificationBell" class="relative bg-white rounded-full p-3 shadow-lg hover:shadow-xl transition duration-300"> 
        <i class="fas fa-bell text-2xl text-teal-500"></i> 
        <span id="notificationBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center hidden">0</span> 
    </button>
    
    <div class="relative">
        <button id="userMenuButton" class="flex items-center space-x-2 bg-white rounded-full p-2 pr-4 shadow-lg hover:shadow-xl transition duration-300 text-left">
            <i class="fas fa-user-circle text-3xl text-teal-500 ml-1"></i>
            <div>
                <p class="font-semibold text-sm text-gray-800" id="currentUserDisplayHeader">-</p>
                <p class="text-xs text-gray-500" id="currentUserRoleHeader">-</p>
            </div>
        </button>
        <div id="userDropdown" class="absolute top-14 right-0 w-48 bg-white rounded-xl shadow-2xl z-40 hidden p-2">
            <a href="#" id="changePasswordBtn" class="flex items-center space-x-3 p-3 text-gray-700 hover:bg-gray-100 rounded-lg transition duration-200">
                <i class="fas fa-key w-5"></i> <span>เปลี่ยนรหัสผ่าน</span>
            </a>
            <a href="#" id="logoutBtn" class="flex items-center space-x-3 p-3 text-red-600 hover:bg-red-50 rounded-lg transition duration-200">
                 <i class="fas fa-sign-out-alt w-5"></i> <span>ออกจากระบบ</span>
            </a>
        </div>
    </div>
   </div>

   <div id="notificationDropdown" class="fixed top-20 right-4 w-96 bg-white rounded-2xl shadow-2xl z-40 hidden max-h-96 overflow-y-auto">
    <div class="p-4 border-b border-gray-200">
     <h3 class="text-lg font-bold text-gray-800">การแจ้งเตือน</h3>
    </div>
    <div id="notificationDropdownContent" class="p-4"></div>
   </div>

   <div id="sidebarBackdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>

   <aside id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-50 transition-all duration-300 transform -translate-x-full md:translate-x-0">
    <div class="p-6 border-b border-gray-200">
     <div class="flex items-center space-x-3">
      <i class="fas fa-file-contract text-3xl text-teal-500"></i>
      <div class="sidebar-brand-text">
       <h2 class="text-xl font-bold text-gray-800">ระบบจัดการสัญญา</h2>
       <p class="text-xs text-gray-500">Contract Management</p>
      </div>
     </div>
    </div>
    <nav class="p-4">
        <a href="#" data-page="dashboard" class="sidebar-menu-item active flex items-center space-x-3 p-3 rounded-lg mb-2 text-gray-700"> <i class="fas fa-chart-line w-5"></i> <span class="sidebar-text">Dashboard</span> </a> 
        <a href="#" data-page="contracts" class="sidebar-menu-item flex items-center space-x-3 p-3 rounded-lg mb-2 text-gray-700"> <i class="fas fa-file-contract w-5"></i> <span class="sidebar-text">สัญญาเช่า</span> </a> 
        <a href="#" data-page="notifications" class="sidebar-menu-item flex items-center space-x-3 p-3 rounded-lg mb-2 text-gray-700"> <i class="fas fa-bell w-5"></i> <span class="sidebar-text">แจ้งเตือน</span> </a> 
        <a href="#" data-page="reports" class="sidebar-menu-item flex items-center space-x-3 p-3 rounded-lg mb-2 text-gray-700"> <i class="fas fa-chart-bar w-5"></i> <span class="sidebar-text">รายงาน</span> </a> 
        <a href="#" data-page="logs" class="sidebar-menu-item flex items-center space-x-3 p-3 rounded-lg mb-2 text-gray-700"> <i class="fas fa-history w-5"></i> <span class="sidebar-text">Logs</span> </a> 
        <a href="#" data-page="users" class="sidebar-menu-item flex items-center space-x-3 p-3 rounded-lg mb-2 text-gray-700"> <i class="fas fa-users w-5"></i> <span class="sidebar-text">จัดการผู้ใช้</span> </a> 
        <a href="#" data-page="about" class="sidebar-menu-item flex items-center space-x-3 p-3 rounded-lg mb-2 text-gray-700"> <i class="fas fa-info-circle w-5"></i> <span class="sidebar-text">เกี่ยวกับระบบ</span> </a> 
    </nav>
    
    <div class="absolute bottom-4 left-0 w-full px-4">
        <button id="sidebarToggleDesktop" class="hidden md:flex items-center justify-center w-full h-10 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-300">
            <i class="fas fa-chevron-left text-gray-600 transition-all duration-300"></i>
        </button>
    </div>

   </aside>

   <main id="mainContent" class="md:ml-64 p-8 relative transition-all duration-300">

    <div id="loadingOverlay" class="absolute inset-0 bg-white bg-opacity-75 z-50 hidden items-center justify-center rounded-2xl">
     <span class="loader"></span>
    </div>
    <div id="dashboardPage" class="page-content">
     <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">Dashboard ภาพรวมระบบ</h1>
      <p class="text-gray-600">ภาพรวมข้อมูลสัญญาเช่าทั้งหมด</p>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
      <div class="bg-gradient-to-br from-blue-400 to-blue-500 rounded-2xl shadow-md p-6 text-white card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-blue-100 text-sm mb-1">จำนวนสาขาทั้งหมด</p>
         <h3 class="text-4xl font-bold" id="totalBranches">0</h3>
        </div><i class="fas fa-building text-5xl text-blue-200"></i>
       </div>
      </div>
      <div class="bg-gradient-to-br from-teal-400 to-teal-500 rounded-2xl shadow-md p-6 text-white card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-teal-100 text-sm mb-1">ยังไม่ครบกำหนด</p>
         <h3 class="text-4xl font-bold" id="activeContracts">0</h3>
        </div><i class="fas fa-check-circle text-5xl text-teal-200"></i>
       </div>
      </div>
      <div class="bg-gradient-to-br from-orange-400 to-orange-500 rounded-2xl shadow-md p-6 text-white card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-orange-100 text-sm mb-1">ใกล้หมดอายุ (60 วัน)</p>
         <h3 class="text-4xl font-bold" id="expiringContracts">0</h3>
        </div><i class="fas fa-exclamation-triangle text-5xl text-orange-200"></i>
       </div>
      </div>
      <div class="bg-gradient-to-br from-red-400 to-red-500 rounded-2xl shadow-md p-6 text-white card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-red-100 text-sm mb-1">หมดอายุแล้ว</p>
         <h3 class="text-4xl font-bold" id="expiredContracts">0</h3>
        </div><i class="fas fa-times-circle text-5xl text-red-200"></i>
       </div>
      </div>
      <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl shadow-md p-6 text-white card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-green-100 text-sm mb-1">ค่าเช่ารวม (ต่อเดือน)</p>
         <h3 class="text-3xl font-bold" id="totalRent">฿0</h3>
        </div><i class="fas fa-money-bill-wave text-5xl text-green-200"></i>
       </div>
      </div>
     </div>
     <div class="flex flex-wrap gap-4 mb-8">
      <button id="addContractDashboardBtn" data-page="addContract" class="bg-teal-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-teal-600 transition duration-300"> <i class="fas fa-plus mr-2"></i>เพิ่มสัญญาใหม่ </button>
      <button data-page="reports" class="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition duration-300"> <i class="fas fa-chart-bar mr-2"></i>ดูรายงานสรุป </button>
     </div>
     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="bg-white rounded-2xl shadow-md p-6">
       <h2 class="text-xl font-bold text-gray-800 mb-4">สถานะสัญญา</h2>
       <div class="w-1/2 mx-auto"> 
        <canvas id="statusChart"></canvas>
       </div>
      </div>
      <div class="bg-white rounded-2xl shadow-md p-6">
       <h2 class="text-xl font-bold text-gray-800 mb-4">ค่าเช่ารายเดือนตามเขต</h2>
       <div class="w-2/3 mx-auto">
        <canvas id="regionChart"></canvas>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-2xl shadow-md p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">สัญญาที่ใกล้หมดอายุล่าสุด (5 รายการ)</h2>
      <div class="table-container">
       <table>
        <thead>
         <tr>
          <th>รหัสสาขา</th>
          <th>ชื่ออาคาร</th>
          <th>วันสิ้นสุด</th>
          <th>คงเหลือ (วัน)</th>
          <th>สถานะ</th>
         </tr>
        </thead>
        <tbody id="expiringContractsTable"></tbody>
       </table>
      </div>
     </div>
    </div>
    <div id="contractsPage" class="page-content hidden">
     <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">จัดการสัญญาเช่า</h1>
      <p class="text-gray-600">รายการสัญญาเช่าทั้งหมด</p>
     </div>
     <div class="bg-white rounded-2xl shadow-md p-6 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
       <div><input type="text" id="filterDistrict" list="district-list" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="พิมพ์เพื่อค้นหาเขต..."><datalist id="district-list"></datalist>
       </div>
       <div><input type="text" id="filterBranch" list="branch-list" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="พิมพ์เพื่อค้นหาสาขา..."><datalist id="branch-list"></datalist>
       </div><select id="filterStatus" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"> <option value="">ทุกสถานะ</option> <option value="active">ยังไม่ครบกำหนด</option> <option value="expiring">ใกล้หมดอายุ</option> <option value="expired">หมดอายุแล้ว</option> </select>
      </div>
     </div>
     
     <div class="bg-white rounded-2xl shadow-md p-6 relative">
      <div id="tableLoadingOverlay" class="absolute inset-0 bg-white bg-opacity-75 z-40 hidden items-center justify-center rounded-2xl">
         <span class="loader"></span>
      </div>

      <div class="flex justify-between items-center mb-4">
       <h2 class="text-xl font-bold text-gray-800">รายการสัญญา</h2><button id="addContractBtn" data-page="addContract" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition duration-300"> <i class="fas fa-plus mr-2"></i>เพิ่มสัญญา </button>
      </div>
      <div class="table-container">
       <table>
        <thead>
         <tr>
          <th>รหัสสาขา</th>
          <th>ชื่อสาขา</th>
          <th>ภาค</th>
          <th>เขต</th>
          <th>จำนวนคูหา</th>
          <th>วันเริ่มต้น</th>
          <th>วันสิ้นสุด</th>
          <th>ค่าเช่า/เดือน</th>
          <th>สถานะ</th>
          <th>จัดการ</th>
         </tr>
        </thead>
        <tbody id="contractsTable"></tbody>
       </table>
      </div>
     </div>
    </div>
    <div id="addContractPage" class="page-content hidden">
     <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">เพิ่มสัญญาใหม่</h1>
      <p class="text-gray-600">กรอกข้อมูลสัญญาเช่าใหม่</p>
     </div>
     <div class="bg-white rounded-2xl shadow-md p-6">
      <form id="addContractForm" class="space-y-4">
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">รหัสสาขา</label> <input type="text" name="branchId" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="เช่น 1ฒ, 5ย">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">ชื่อสาขา</label> <input type="text" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="เช่น บ้านไทรงามพัฒนา">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">ภาค</label> <input type="text" name="regional" value="P026" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">เขต</label> <select name="district" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"> <option value="">เลือกเขต</option> <option value="K012">K012</option> <option value="K122">K122</option> <option value="K189">K189</option> <option value="K195">K195</option> <option value="K196">K196</option> <option value="K247">K247</option> <option value="K273">K273</option> <option value="K358">K358</option> </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">จำนวนคูหา</label> <input type="number" name="unitCount" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="1">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">ค่าเช่ารายเดือน (บาท)</label> <input type="number" name="monthlyRent" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="3000">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">วันเริ่มต้นสัญญา</label> <input type="date" name="startDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">วันสิ้นสุดสัญญา</label> <input type="date" name="endDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
        </div>
        <div class="md:col-span-2">
         <label class="block text-sm font-medium text-gray-700 mb-2">ไฟล์สัญญา (JPG, PNG) - สูงสุด 5 ไฟล์</label> 
         <input type="file" id="addContractFiles" accept="image/jpeg,image/png" multiple class="hidden"> 
         <label for="addContractFiles" id="addContractFileLabel" class="w-full cursor-pointer bg-teal-50 text-teal-700 font-semibold px-4 py-2 border border-gray-300 rounded-lg hover:bg-teal-100 flex items-center justify-center"> 
          <i class="fas fa-upload mr-2"></i> 
          <span>เลือกไฟล์...</span> 
         </label>
         <p class="text-sm text-gray-500 mt-1">ไฟล์จะถูกตั้งชื่อตาม รหัสสาขา_ชื่อสาขา</p>
         <div id="addFilesPreviews" class="mt-3">
          <div id="addFilesPreviewsContainer" class="grid grid-cols-2 md:grid-cols-5 gap-3"></div>
         </div>
        </div>
       </div>
       <div class="flex space-x-4 pt-4"><button type="submit" class="bg-teal-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-teal-600 transition duration-300"> <i class="fas fa-save mr-2"></i>บันทึกสัญญา </button> <button type="button" data-page="contracts" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition duration-300"> <i class="fas fa-times mr-2"></i>ยกเลิก </button>
       </div>
      </form>
     </div>
    </div>
    <div id="notificationsPage" class="page-content hidden">
     <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">แจ้งเตือน</h1>
      <p class="text-gray-600">การแจ้งเตือนสัญญาที่ต้องดำเนินการ</p>
     </div>
     <div class="space-y-4" id="notificationsList"></div>
    </div>
    <div id="reportsPage" class="page-content hidden">
     <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">รายงาน</h1>
      <p class="text-gray-600">รายงานสรุปข้อมูลสัญญาเช่า</p>
     </div>
     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow-md p-6">
       <h2 class="text-xl font-bold text-gray-800 mb-4">สรุปตามสถานะ</h2>
       <div class="space-y-3">
        <div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
         <div class="flex justify-between items-center mb-2"><span class="font-semibold text-gray-700">กำลังเช่า</span> <span class="text-3xl font-bold text-green-600" id="reportActive">0</span>
         </div>
         <div class="flex justify-between items-center text-sm"><span class="text-gray-600">จำนวนเงิน</span> <span class="text-lg font-bold text-green-700" id="reportActiveRent">฿0</span>
         </div>
        </div>
        <div class="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
         <div class="flex justify-between items-center mb-2"><span class="font-semibold text-gray-700">ใกล้หมดอายุ</span> <span class="text-3xl font-bold text-yellow-600" id="reportExpiring">0</span>
         </div>
         <div class="flex justify-between items-center text-sm"><span class="text-gray-600">จำนวนเงิน</span> <span class="text-lg font-bold text-yellow-700" id="reportExpiringRent">฿0</span>
         </div>
        </div>
        <div class="p-4 bg-red-50 rounded-lg border-l-4 border-red-500">
         <div class="flex justify-between items-center mb-2"><span class="font-semibold text-gray-700">หมดอายุ</span> <span class="text-3xl font-bold text-red-600" id="reportExpired">0</span>
         </div>
         <div class="flex justify-between items-center text-sm"><span class="text-gray-600">จำนวนเงิน</span> <span class="text-lg font-bold text-red-700" id="reportExpiredRent">฿0</span>
         </div>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-2xl shadow-md p-6">
       <h2 class="text-xl font-bold text-gray-800 mb-4">สรุปค่าเช่า</h2>
       <div class="space-y-3">
        <div class="p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg border-l-4 border-blue-500">
         <div class="flex justify-between items-center mb-1"><span class="font-semibold text-gray-700">ค่าเช่ารวมทั้งหมด</span>
         </div>
         <div class="text-right"><span class="text-3xl font-bold text-blue-600" id="reportTotalRent">฿0</span>
         </div>
        </div>
        <div class="p-4 bg-gradient-to-r from-indigo-50 to-indigo-100 rounded-lg border-l-4 border-indigo-500">
         <div class="flex justify-between items-center mb-1"><span class="font-semibold text-gray-700">จำนวนสาขา</span>
         </div>
         <div class="text-right"><span class="text-3xl font-bold text-indigo-600" id="reportBranchCount">0</span>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div>
    <div id="logsPage" class="page-content hidden">
     <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">ประวัติการใช้งาน</h1>
      <p class="text-gray-600">บันทึกกิจกรรมทั้งหมด</p>
     </div>
     <div class="bg-white rounded-2xl shadow-md p-6 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
       <div><label for="logStartDate" class="block text-sm font-medium text-gray-700 mb-2">วันที่เริ่มต้น</label> <input type="datetime-local" id="logStartDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
       </div>
       <div><label for="logEndDate" class="block text-sm font-medium text-gray-700 mb-2">วันที่สิ้นสุด</label> <input type="datetime-local" id="logEndDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
       </div>
       <div class="flex space-x-2"><button id="filterLogsBtn" class="w-full bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition duration-300"> <i class="fas fa-filter mr-2"></i>กรองข้อมูล </button> <button id="resetLogsBtn" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-300"> <i class="fas fa-undo mr-2"></i>ล้างค่า </button>
       </div>
      </div>
     </div>

     <div class="bg-white rounded-2xl shadow-md p-6 relative">
      <div id="logsTableLoadingOverlay" class="absolute inset-0 bg-white bg-opacity-75 z-40 hidden items-center justify-center rounded-2xl">
         <span class="loader"></span>
      </div>

      <div class="table-container">
       <table>
        <thead>
         <tr>
          <th>วันที่-เวลา</th>
          <th>ผู้ใช้</th>
          <th>กิจกรรม</th>
          <th>รายละเอียด</th>
         </tr>
        </thead>
        <tbody id="logsTable"></tbody>
       </table>
      </div>
     </div>
    </div>
    <div id="usersPage" class="page-content hidden">
     <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">จัดการผู้ใช้</h1>
      <p class="text-gray-600">จัดการข้อมูลผู้ใช้งานระบบ</p>
     </div>
     
     <div class="bg-white rounded-2xl shadow-md p-6 relative">
      <div id="usersTableLoadingOverlay" class="absolute inset-0 bg-white bg-opacity-75 z-40 hidden items-center justify-center rounded-2xl">
         <span class="loader"></span>
      </div>

      <div class="flex justify-between items-center mb-4">
       <h2 class="text-xl font-bold text-gray-800">รายการผู้ใช้</h2>
       <div class="w-1/3">
           <input type="text" id="userSearchInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="ค้นหาชื่อ หรือ ชื่อผู้ใช้...">
       </div>
       <button id="addUserBtn" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition duration-300"> <i class="fas fa-plus mr-2"></i>เพิ่มผู้ใช้ </button>
      </div>

      <div class="table-container">
       <table>
        <thead>
         <tr>
          <th>ชื่อผู้ใช้</th>
          <th>ชื่อ</th>
          <th>บทบาท</th>
          <th>พื้นที่รับผิดชอบ</th>
          <th class="text-center">เพิ่ม</th>
          <th class="text-center">แก้ไข</th>
          <th class="text-center">ลบ</th>
          <th>จัดการ</th>
         </tr>
        </thead>
        <tbody id="usersTable"></tbody>
       </table>
      </div>
     </div>
    </div>
    <div id="aboutPage" class="page-content hidden">
     <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">เกี่ยวกับระบบ</h1>
      <p class="text-gray-600">ข้อมูลระบบบริหารสัญญาเช่า</p>
     </div>
     <div class="bg-gradient-to-br from-teal-50 to-green-50 rounded-2xl shadow-md p-8">
      <div class="text-center mb-8"><i class="fas fa-file-contract text-6xl text-teal-500 mb-4"></i>
       <h2 class="text-2xl font-bold bg-gradient-to-r from-teal-600 to-green-600 bg-clip-text text-transparent mb-2">ระบบบริหารสัญญาเช่าตึกสำนักงาน</h2>
       <p class="text-teal-700 font-semibold">เวอร์ชัน 1.0.0</p>
      </div>
      <div class="space-y-4">
       <div class="bg-white rounded-xl p-4 shadow-sm">
        <p class="text-lg font-bold text-teal-600 mb-3"><i class="fas fa-star text-yellow-500 mr-2"></i>คุณสมบัติหลัก:</p>
        <ul class="space-y-2 list-inside">
         <li class="flex items-start"><span class="bg-teal-100 text-teal-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">1</span> <span>จัดการสัญญาเช่าอาคารสำนักงาน</span></li>
         <li class="flex items-start"><span class="bg-orange-100 text-orange-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">2</span> <span>แจ้งเตือนสัญญาที่ใกล้หมดอายุ</span></li>
         <li class="flex items-start"><span class="bg-blue-100 text-blue-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">3</span> <span>รายงานสรุปค่าเช่าและสถานะสัญญา</span></li>
         <li class="flex items-start"><span class="bg-purple-100 text-purple-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">4</span> <span>บันทึกประวัติการใช้งาน</span></li>
         <li class="flex items-start"><span class="bg-green-100 text-green-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">5</span> <span>เชื่อมต่อกับ Google Sheets</span></li>
         <li class="flex items-start"><span class="bg-pink-100 text-pink-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">6</span> <span>Dashboard แสดงภาพรวมด้วยกราฟ</span></li>
        </ul>
       </div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </main>
   <div id="addUserModal" class="modal">
    <div class="modal-content">
     <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-gray-800">เพิ่มผู้ใช้ใหม่</h2><button id="closeAddUserModal" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-2xl"></i> </button>
     </div>
     <form id="addUserForm" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">ชื่อผู้ใช้</label> <input type="text" name="username" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
       </div>
       <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">รหัสผ่าน</label> <input type="password" name="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
       </div>
       <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">ชื่อ</label> <input type="text" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">บทบาท</label> <select name="role" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"> <option value="">เลือกบทบาท</option> <option value="Admin">Admin</option> <option value="Regional Manager">Regional Manager</option> <option value="District Manager">District Manager</option> <option value="Branch User">Branch User</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">พื้นที่รับผิดชอบ</label> <input type="text" name="permissionArea" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="ALL, P026, K273">
       </div>
       <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">สิทธิ์การใช้งานสัญญา</label>
        <div class="flex space-x-6"><label class="flex items-center"> <input type="checkbox" name="canAdd" class="mr-2 h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded"> เพิ่มข้อมูล </label> <label class="flex items-center"> <input type="checkbox" name="canEdit" class="mr-2 h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded"> แก้ไขข้อมูล </label> <label class="flex items-center"> <input type="checkbox" name="canDelete" class="mr-2 h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded"> ลบข้อมูล </label>
        </div>
       </div>
      </div>
      <div class="pt-4 flex space-x-4"><button type="submit" class="bg-teal-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-teal-600 transition duration-300"> <i class="fas fa-save mr-2"></i>บันทึก </button> <button type="button" id="cancelAddUser" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition duration-300"> <i class="fas fa-times mr-2"></i>ยกเลิก </button>
      </div>
     </form>
    </div>
   </div>
   <div id="editUserModal" class="modal">
    <div class="modal-content">
     <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-gray-800">แก้ไขผู้ใช้</h2><button id="closeEditUserModal" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-2xl"></i> </button>
     </div>
     <form id="editUserForm" class="space-y-4"><input type="hidden" name="originalUsername" id="editUserOriginalUsername">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">ชื่อผู้ใช้</label> <input type="text" name="username" id="editUserUsername" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
       </div>
       <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">รหัสผ่าน (เว้นว่างหากไม่ต้องการเปลี่ยน)</label> <input type="password" name="password" id="editUserPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
       </div>
       <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">ชื่อ</label> <input type="text" name="name" id="editUserName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">บทบาท</label> <select name="role" id="editUserRole" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"> <option value="">เลือกบทบาท</option> <option value="Admin">Admin</option> <option value="Regional Manager">Regional Manager</option> <option value="District Manager">District Manager</option> <option value="Branch User">Branch User</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">พื้นที่รับผิดชอบ</label> <input type="text" name="permissionArea" id="editUserPermissionArea" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
       </div>
       <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">สิทธิ์การใช้งานสัญญา</label>
        <div class="flex space-x-6"><label class="flex items-center"> <input type="checkbox" name="canAdd" id="editUserCanAdd" class="mr-2 h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded"> เพิ่มข้อมูล </label> <label class="flex items-center"> <input type="checkbox" name="canEdit" id="editUserCanEdit" class="mr-2 h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded"> แก้ไขข้อมูล </label> <label class="flex items-center"> <input type="checkbox" name="canDelete" id="editUserCanDelete" class="mr-2 h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded"> ลบข้อมูล </label>
        </div>
       </div>
      </div>
      <div class="pt-4 flex space-x-4"><button type="submit" class="bg-teal-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-teal-600 transition duration-300"> <i class="fas fa-save mr-2"></i>บันทึก </button> <button type="button" id="cancelEditUser" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition duration-300"> <i class="fas fa-times mr-2"></i>ยกเลิก </button>
      </div>
     </form>
    </div>
   </div>
   <div id="editModal" class="modal">
    <div class="modal-content">
     <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-gray-800">แก้ไขสัญญา</h2><button id="closeEditModal" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-2xl"></i> </button>
     </div>
     <form id="editContractForm" class="space-y-4"><input type="hidden" name="id" id="editId">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">รหัสสาขา</label> <input type="text" name="branchId" id="editBranchId" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ชื่อสาขา</label> <input type="text" name="name" id="editName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ภาค</label> <input type="text" name="regional" id="editRegional" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">เขต</label> <input type="text" name="district" id="editDistrict" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">จำนวนคูหา</label> <input type="number" name="unitCount" id="editUnitCount" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ค่าเช่ารายเดือน (บาท)</label> <input type="number" name="monthlyRent" id="editMonthlyRent" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">วันเริ่มต้นสัญญา</label> <input type="date" name="startDate" id="editStartDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">วันสิ้นสุดสัญญา</label> <input type="date" name="endDate" id="editEndDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
       </div>
       <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-2">ไฟล์สัญญา</label>
        <div id="editCurrentFiles" class="mt-1">
         <p class="text-sm font-medium text-gray-700 mb-2">ไฟล์ปัจจุบัน:</p>
         <div id="editCurrentFilesContainer" class="grid grid-cols-2 md:grid-cols-5 gap-3"></div>
        </div>
        <div id="editNewFiles" class="mt-3">
         <p class="text-sm font-medium text-gray-700 mb-2">เพิ่มไฟล์ใหม่ (สูงสุด 5 ไฟล์รวมทั้งหมด):</p>
         <input type="file" id="editContractFiles" accept="image/jpeg,image/png" multiple class="hidden"> 
         <label for="editContractFiles" id="editContractFileLabel" class="w-full cursor-pointer bg-teal-50 text-teal-700 font-semibold px-4 py-2 border border-gray-300 rounded-lg hover:bg-teal-100 flex items-center justify-center"> 
          <i class="fas fa-upload mr-2"></i> 
          <span>เลือกไฟล์...</span> 
         </label>
         <div id="editFilesPreviewsContainer" class="grid grid-cols-2 md:grid-cols-5 gap-3 mt-3"></div>
        </div>
       </div>
      </div>
      <div class="pt-4 flex space-x-4"><button type="submit" class="bg-teal-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-teal-600 transition duration-300"> <i class="fas fa-save mr-2"></i>บันทึก </button> <button type="button" id="cancelEdit" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition duration-300"> <i class="fas fa-times mr-2"></i>ยกเลิก </button>
      </div>
     </form>
    </div>
   </div>
   
    <div id="changePasswordModal" class="modal">
        <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">เปลี่ยนรหัสผ่าน</h2>
                <button id="closeChangePasswordModal" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-2xl"></i> </button>
            </div>
            <form id="changePasswordForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">รหัสผ่านเดิม</label>
                    <input type="password" name="oldPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">รหัสผ่านใหม่</label>
                    <input type="password" name="newPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ยืนยันรหัสผ่านใหม่</label>
                    <input type="password" name="confirmPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                </div>
                <div class="pt-4 flex space-x-4">
                    <button type="submit" class="bg-teal-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-teal-600 transition duration-300">
                        <i class="fas fa-key mr-2"></i>ยืนยันการเปลี่ยนแปลง
                    </button>
                    <button type="button" id="cancelChangePassword" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition duration-300">
                        <i class="fas fa-times mr-2"></i>ยกเลิก
                    </button>
                </div>
            </form>
        </div>
    </div>

  </div>
  <script>
    const GAS_CONFIG = {
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // !!! สำคัญ: กรุณาใส่ URL ตัวใหม่ล่าสุดที่ได้จากการ Deploy ของคุณที่นี่ !!!
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        API_URL: 'https://script.google.com/macros/s/AKfycbynnJlF5ddIN7m8MCLjOaInasnnhcW-rXpqC--gUYqyLvPHfeF8aLoHrIAR932rXGjBAQ/exec', 
        TIMEOUT: 60000 
    };
    const CONFIG = { currentUser: null, contracts: [], branches: [], logs: [], users: [], statusChart: null, regionChart: null, isSidebarCollapsed: false };
    
    const fileManager = {
        add: [],
        edit: { new: [], existing: [], toDelete: [] },
        resetAdd: function() { this.add = []; },
        resetEdit: function() { this.edit = { new: [], existing: [], toDelete: [] }; }
    };

    async function apiRequest(action, params = {}, method = 'GET') {
        const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Request timeout')), GAS_CONFIG.TIMEOUT)
        );

        let requestPromise;
        if (method === 'GET') {
            const queryParams = new URLSearchParams({ action, ...params, callback: 'dummy' });
            requestPromise = fetch(`${GAS_CONFIG.API_URL}?${queryParams.toString()}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.text();
                })
                .then(text => {
                    const jsonpData = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
                    return JSON.parse(jsonpData);
                });
        } else { // POST
            const body = { action, ...params };
            requestPromise = fetch(GAS_CONFIG.API_URL, {
                method: 'POST',
                body: JSON.stringify(body),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            }).then(response => {
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                return response.json(); // คาดหวัง JSON ธรรมดา
            });
        }

        const response = await Promise.race([requestPromise, timeoutPromise]);
        if (response && typeof response.success !== 'undefined') {
            if (response.success) {
                return response;
            } else {
                throw new Error(response.message || 'Server error');
            }
        } else {
           throw new Error('Invalid response from server');
        }
    }
    
    const api = {
        authenticateUser: (u, p) => apiRequest('authenticateUser', { username: u, password: p }),
        getContracts: () => apiRequest('getContracts', { userRole: CONFIG.currentUser?.role, userPermissionArea: CONFIG.currentUser?.permissionArea }),
        getBranches: () => apiRequest('getBranches', { userRole: CONFIG.currentUser?.role, userPermissionArea: CONFIG.currentUser?.permissionArea }),
        getLogs: () => apiRequest('getLogs', { userRole: CONFIG.currentUser?.role }),
        getUsers: () => apiRequest('getUsers', { userRole: CONFIG.currentUser?.role }),
        addContract: d => apiRequest('addContract', { ...d, currentUser: CONFIG.currentUser }, 'POST'),
        updateContract: d => apiRequest('updateContract', { ...d, currentUser: CONFIG.currentUser }, 'POST'),
        deleteContract: id => apiRequest('deleteContract', { id, currentUser: CONFIG.currentUser }, 'POST'),
        addUser: d => apiRequest('addUser', { ...d, currentUser: CONFIG.currentUser }, 'POST'),
        updateUser: d => apiRequest('updateUser', { ...d, currentUser: CONFIG.currentUser }, 'POST'),
        deleteUser: u => apiRequest('deleteUser', { username: u, currentUser: CONFIG.currentUser }, 'POST'),
        changePassword: d => apiRequest('changePassword', { ...d, currentUser: CONFIG.currentUser }, 'POST')
    };

    const UI = {
        showLoading: () => document.getElementById('loadingOverlay').classList.replace('hidden', 'flex'),
        hideLoading: () => document.getElementById('loadingOverlay').classList.replace('flex', 'hidden'),
        showToast: (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = 'toast';
            const icon = type === 'success' ? 'fa-check-circle text-green-500' : 'fa-exclamation-circle text-red-500';
            toast.innerHTML = `<div class="flex items-center space-x-3"><i class="fas ${icon} text-2xl"></i><span>${message}</span></div>`;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        },
        updateVisibility: () => {
            const user = CONFIG.currentUser; if (!user) return;
            const elements = {
                logsMenu: document.querySelector('[data-page="logs"]'),
                usersMenu: document.querySelector('[data-page="users"]'),
                addDashboardBtn: document.getElementById('addContractDashboardBtn'),
                addContractsBtn: document.getElementById('addContractBtn')
            };

            elements.logsMenu.style.display = user.role === 'Admin' ? 'flex' : 'none';
            elements.usersMenu.style.display = user.role === 'Admin' ? 'flex' : 'none';
            elements.addDashboardBtn.style.display = user.canAdd ? 'block' : 'none';
            elements.addContractsBtn.style.display = user.canAdd ? 'block' : 'none';
        },
        showNotificationPopup: () => {
            if (!CONFIG.contracts || CONFIG.contracts.length === 0) return;
            const expiring = CONFIG.contracts.filter(c => getContractStatus(c.endDate) === 'expiring').length;
            const expired = CONFIG.contracts.filter(c => getContractStatus(c.endDate) === 'expired').length;
            if (expiring > 0 || expired > 0) {
                let html = '<div class="text-left">';
                if (expired > 0) html += `<p class="mb-2"><i class="fas fa-times-circle text-red-500 mr-2"></i>สัญญาหมดอายุ: <strong>${expired}</strong> รายการ</p>`;
                if (expiring > 0) html += `<p><i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>สัญญาใกล้หมดอายุ: <strong>${expiring}</strong> รายการ</p>`;
                Swal.fire({ title: 'แจ้งเตือนสัญญา', html: html + '</div>', icon: 'warning', confirmButtonColor: '#26A69A' });
            }
        }
    };
    
    const format = {
        currency: amount => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 0 }).format(amount || 0),
        date: dateString => { try { return new Date(dateString).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }); } catch { return ''; } }
    };
    const getContractStatus = endDate => { const d = Math.ceil((new Date(endDate) - new Date()) / 864e5); return d < 1 ? 'expired' : (d <= 60 ? 'expiring' : 'active'); };
    const getDaysRemaining = endDate => Math.ceil((new Date(endDate) - new Date()) / 864e5);
    const getStatusBadge = status => ({ active: '<span class="badge badge-active">ยังไม่ครบกำหนด</span>', expiring: '<span class="badge badge-expiring">ใกล้หมดอายุ</span>', expired: '<span class="badge badge-expired">หมดอายุแล้ว</span>' })[status] || '';

    function toggleSidebarDesktop() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const sidebarTexts = document.querySelectorAll('.sidebar-text');
        const sidebarBrandText = document.querySelector('.sidebar-brand-text');
        const sidebarMenuItems = document.querySelectorAll('.sidebar-menu-item');
        const toggleIcon = document.querySelector('#sidebarToggleDesktop i');

        CONFIG.isSidebarCollapsed = !CONFIG.isSidebarCollapsed;
        localStorage.setItem('sidebarCollapsed', CONFIG.isSidebarCollapsed);

        if (CONFIG.isSidebarCollapsed) {
            sidebar.classList.remove('w-64');
            sidebar.classList.add('w-[4.5rem]'); // 72px
            mainContent.classList.remove('md:ml-64');
            mainContent.classList.add('md:ml-[4.5rem]');
            sidebarTexts.forEach(span => span.classList.add('hidden'));
            sidebarBrandText.classList.add('hidden');
            sidebarMenuItems.forEach(item => item.classList.add('justify-center'));
            toggleIcon.classList.replace('fa-chevron-left', 'fa-chevron-right');
        } else {
            sidebar.classList.add('w-64');
            sidebar.classList.remove('w-[4.5rem]');
            mainContent.classList.add('md:ml-64');
            mainContent.classList.remove('md:ml-[4.5rem]');
            sidebarTexts.forEach(span => span.classList.remove('hidden'));
            sidebarBrandText.classList.remove('hidden');
            sidebarMenuItems.forEach(item => item.classList.remove('justify-center'));
            toggleIcon.classList.replace('fa-chevron-right', 'fa-chevron-left');
        }
    }

    function toggleSidebarMobile() {
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('sidebarBackdrop');
        sidebar.classList.toggle('-translate-x-full');
        backdrop.classList.toggle('hidden');
    }

    function checkSidebarState() {
        // ตั้งค่าเริ่มต้นสำหรับมือถือ (ซ่อนไว้ก่อน)
        document.getElementById('sidebar').classList.add('-translate-x-full', 'md:translate-x-0');
        document.getElementById('sidebarBackdrop').classList.add('hidden');

        // ตรวจสอบสถานะย่อ/ขยายที่บันทึกไว้สำหรับ Desktop
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            CONFIG.isSidebarCollapsed = false; // ตั้งเป็น false เพื่อให้ฟังก์ชัน toggle ทำงานถูกต้อง
            toggleSidebarDesktop();
        }
    }

    async function login(username, password) {
        const loginButton = document.querySelector('#loginForm button[type="submit"]');
        
        const originalContent = loginButton.innerHTML; 
        loginButton.disabled = true;
        
        loginButton.style.height = `${loginButton.offsetHeight}px`; 
        loginButton.classList.add('flex', 'items-center', 'justify-center');
        loginButton.innerHTML = `<span class="loader"></span>`;

        try {
            const { user } = await api.authenticateUser(username, password);
            CONFIG.currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(user));
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('currentUserDisplayHeader').textContent = user.name || user.username;
            document.getElementById('currentUserRoleHeader').textContent = user.role || 'User';
            
            UI.updateVisibility();
            UI.showToast('เข้าสู่ระบบสำเร็จ!');
            await loadDashboard();
        } catch (error) { 
            UI.showToast(error.message || 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง', 'error');
        } finally { 
            loginButton.disabled = false;
            loginButton.style.height = null; 
            loginButton.classList.remove('flex', 'items-center', 'justify-center'); 
            loginButton.innerHTML = originalContent; 
        }
    }
    function logout() {
        Swal.fire({ title: 'ออกจากระบบ?', text: 'คุณต้องการออกจากระบบใช่หรือไม่?', icon: 'question', showCancelButton: true, confirmButtonText: 'ออกจากระบบ', cancelButtonText: 'ยกเลิก' }).then(result => {
            if (result.isConfirmed) { localStorage.removeItem('currentUser'); window.location.reload(); }
        });
    }

    function updateNotificationBell() {
        if(!CONFIG.contracts) return;
        const notifications = CONFIG.contracts.filter(c => getContractStatus(c.endDate) !== 'active');
        const badge = document.getElementById('notificationBadge');
        if (notifications.length > 0) {
            badge.textContent = notifications.length;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
        return notifications;
    }
    function loadNotificationDropdown() {
        const notifications = updateNotificationBell();
        const content = document.getElementById('notificationDropdownContent');
        if(!notifications) {
            content.innerHTML = '<p class="text-center text-gray-500 py-4">ไม่มีการแจ้งเตือน</p>';
            return;
        }
        content.innerHTML = notifications.length === 0 ? '<p class="text-center text-gray-500 py-4">ไม่มีการแจ้งเตือน</p>' : 
            notifications.slice(0, 5).map(c => {
                const status = getContractStatus(c.endDate);
                const icon = status === 'expired' ? 'fa-times-circle text-red-500' : 'fa-exclamation-triangle text-yellow-500';
                return `<div class="p-3 mb-2 rounded-lg ${status === 'expired' ? 'bg-red-50' : 'bg-yellow-50'}"><div class="flex items-start space-x-2">
                    <i class="fas ${icon} mt-1"></i>
                    <div><p class="font-semibold text-sm">${c.name}</p><p class="text-xs text-gray-600">${c.branchId} | เหลือ ${getDaysRemaining(c.endDate)} วัน</p></div>
                </div></div>`;
            }).join('');
    }
    
    async function loadDashboard() {
        UI.showLoading();
        try {
            const [{ data: contracts }, { data: branches }] = await Promise.all([api.getContracts(), api.getBranches()]);
            CONFIG.contracts = contracts; CONFIG.branches = branches;
            const statusCounts = contracts.reduce((acc, c) => { acc[getContractStatus(c.endDate)] = (acc[getContractStatus(c.endDate)] || 0) + 1; return acc; }, { active: 0, expiring: 0, expired: 0 });
            document.getElementById('totalBranches').textContent = new Set(contracts.map(c => c.branchId)).size;
            document.getElementById('activeContracts').textContent = statusCounts.active;
            document.getElementById('expiringContracts').textContent = statusCounts.expiring;
            document.getElementById('expiredContracts').textContent = statusCounts.expired;
            document.getElementById('totalRent').textContent = format.currency(contracts.reduce((sum, c) => sum + c.monthlyRent, 0));
            const expiringList = contracts.filter(c => getContractStatus(c.endDate) !== 'active').sort((a, b) => getDaysRemaining(a.endDate) - getDaysRemaining(b.endDate)).slice(0, 5);
            document.getElementById('expiringContractsTable').innerHTML = expiringList.length ? expiringList.map(c => `<tr><td>${c.branchId}</td><td>${c.name}</td><td>${format.date(c.endDate)}</td><td>${getDaysRemaining(c.endDate)} วัน</td><td>${getStatusBadge(getContractStatus(c.endDate))}</td></tr>`).join('') : `<tr><td colspan="5" class="text-center text-gray-500">ไม่มีสัญญาที่ใกล้หมดอายุ</td></tr>`;
            if (CONFIG.statusChart) CONFIG.statusChart.destroy();
            
            // --- START: ‼️ แก้ไข (ปรับป้ายกำกับและขนาดกล่อง) ‼️ ---
            CONFIG.statusChart = new Chart(document.getElementById('statusChart'), { 
                type: 'doughnut', 
                data: { 
                    labels: ['ยังไม่ครบกำหนด', 'ใกล้หมดอายุ (60 วัน)', 'หมดอายุแล้ว'], // <-- คืนค่า (60 วัน)
                    datasets: [{ 
                        data: [statusCounts.active, statusCounts.expiring, statusCounts.expired], 
                        backgroundColor: ['#4DB6AC', '#FFA726', '#EF5350'], 
                        borderWidth: 0 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    cutout: '50%', 
                    plugins: { 
                        legend: { 
                            position: 'top', // <-- คงไว้ที่ด้านบน
                            labels: { 
                                font: { family: 'Kanit' },
                                boxWidth: 14 // <-- ลดขนาดกล่องสี
                            } 
                        } 
                    } 
                } 
            });
            // --- END: ‼️ แก้ไข ‼️ ---

            const districtData = contracts.reduce((acc, c) => { acc[c.district] = (acc[c.district] || 0) + c.monthlyRent; return acc; }, {});
            const sortedDistricts = Object.keys(districtData).sort();
            if (CONFIG.regionChart) CONFIG.regionChart.destroy();
            CONFIG.regionChart = new Chart(document.getElementById('regionChart'), { type: 'bar', data: { labels: sortedDistricts, datasets: [{ label: 'ค่าเช่า', data: sortedDistricts.map(d => districtData[d]), backgroundColor: '#26A69A' }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: value => format.currency(value) } } } } });
            updateNotificationBell();
            setTimeout(UI.showNotificationPopup, 1000);
        } catch (error) { UI.showToast(`โหลด Dashboard ไม่สำเร็จ: ${error.message}`, 'error'); }
        finally { 
            UI.hideLoading(); 
            document.getElementById('dashboardPage').classList.add('animate-page-load');
        }
    }
    
    async function loadContractsPage() {
        const tableLoader = document.getElementById('tableLoadingOverlay');
        tableLoader.classList.replace('hidden', 'flex'); 
        try {
            const { data: contracts } = await api.getContracts();
            CONFIG.contracts = contracts;
            const uniqueDistricts = [...new Set(contracts.map(item => item.district))].sort();
            const uniqueBranches = [...new Set(contracts.map(item => item.branchId))].sort();
            document.getElementById('district-list').innerHTML = uniqueDistricts.map(o => `<option value="${o}"></option>`).join('');
            document.getElementById('branch-list').innerHTML = uniqueBranches.map(o => `<option value="${o}"></option>`).join('');
            renderContractsTable(contracts);
        } catch (error) { UI.showToast(`โหลดสัญญาไม่สำเร็จ: ${error.message}`, 'error'); }
        finally { 
            tableLoader.classList.replace('flex', 'hidden'); 
            document.getElementById('contractsPage').classList.add('animate-page-load');
        }
    }
    
    async function loadLogsPage() {
        const tableLoader = document.getElementById('logsTableLoadingOverlay');
        tableLoader.classList.replace('hidden', 'flex'); 
        try {
            const { data: logs } = await api.getLogs();
            CONFIG.logs = logs;
            renderLogsTable(logs);
        } catch (error) { UI.showToast(`โหลด Logs ไม่สำเร็จ: ${error.message}`, 'error'); }
        finally { 
            tableLoader.classList.replace('flex', 'hidden'); 
            document.getElementById('logsPage').classList.add('animate-page-load');
        }
    }
    
    async function loadUsersPage() {
        const tableLoader = document.getElementById('usersTableLoadingOverlay');
        tableLoader.classList.replace('hidden', 'flex'); 
        try {
            const { data: users } = await api.getUsers(); 
            CONFIG.users = users; 
            renderUsersTable(users); 
        } catch (error) { UI.showToast(`โหลดผู้ใช้ไม่สำเร็จ: ${error.message}`, 'error'); }
        finally { 
            tableLoader.classList.replace('flex', 'hidden'); 
            document.getElementById('usersPage').classList.add('animate-page-load');
        }
    }
    
    async function loadReportsPage() {
        UI.showLoading();
        try {
            const contracts = CONFIG.contracts.length === 0 ? (await api.getContracts()).data : CONFIG.contracts;
            const active = contracts.filter(c => getContractStatus(c.endDate) === 'active');
            const expiring = contracts.filter(c => getContractStatus(c.endDate) === 'expiring');
            const expired = contracts.filter(c => getContractStatus(c.endDate) === 'expired');
            const sumRent = arr => arr.reduce((sum, c) => sum + (c.monthlyRent || 0), 0);
            document.getElementById('reportActive').textContent = active.length;
            document.getElementById('reportExpiring').textContent = expiring.length;
            document.getElementById('reportExpired').textContent = expired.length;
            document.getElementById('reportActiveRent').textContent = format.currency(sumRent(active));
            document.getElementById('reportExpiringRent').textContent = format.currency(sumRent(expiring));
            document.getElementById('reportExpiredRent').textContent = format.currency(sumRent(expired));
            document.getElementById('reportTotalRent').textContent = format.currency(sumRent(contracts));
            document.getElementById('reportBranchCount').textContent = new Set(contracts.map(c => c.branchId)).size;
        } catch (error) { UI.showToast(`โหลดรายงานไม่สำเร็จ: ${error.message}`, 'error'); }
        finally { 
            UI.hideLoading(); 
            document.getElementById('reportsPage').classList.add('animate-page-load');
        }
    }
    async function loadNotificationsPage() {
        UI.showLoading();
        try {
            const contracts = CONFIG.contracts.length === 0 ? (await api.getContracts()).data : CONFIG.contracts;
            const notifications = contracts.filter(c => getContractStatus(c.endDate) !== 'active').sort((a, b) => new Date(a.endDate) - new Date(b.endDate));
            const container = document.getElementById('notificationsList');
            container.innerHTML = notifications.length ? notifications.map(c => {
                const status = getContractStatus(c.endDate);
                return `<div class="bg-white rounded-2xl shadow-md p-6 border-l-4 ${status === 'expired' ? 'border-red-500' : 'border-yellow-500'}">
                <div class="flex items-start space-x-4"><i class="fas ${status === 'expired' ? 'fa-times-circle text-red-500' : 'fa-exclamation-triangle text-yellow-500'} text-3xl mt-1"></i>
                <div class="flex-1"><h3 class="text-lg font-bold">${c.name}</h3>
                <p class="text-gray-600">รหัสสาขา: ${c.branchId} | เขต: ${c.district}</p>
                <p class="text-gray-600">วันสิ้นสุด: ${format.date(c.endDate)} | คงเหลือ: <strong>${getDaysRemaining(c.endDate)} วัน</strong></p>
                <p class="font-semibold">ค่าเช่า: ${format.currency(c.monthlyRent)}/เดือน</p>
                </div><div>${getStatusBadge(status)}</div></div></div>`;
            }).join('') : '<div class="bg-white rounded-2xl shadow-md p-6 text-center text-gray-500">ไม่มีการแจ้งเตือน</div>';
        } catch (error) { UI.showToast(`โหลดแจ้งเตือนไม่สำเร็จ: ${error.message}`, 'error'); }
        finally { 
            UI.hideLoading(); 
            document.getElementById('notificationsPage').classList.add('animate-page-load');
        }
    }

    async function viewContractFiles(id) {
        const contract = CONFIG.contracts.find(c => c.id === id);
        if (!contract || !contract.contractFilesData || contract.contractFilesData.length === 0) {
            UI.showToast('ไม่พบไฟล์สำหรับสัญญานี้', 'error');
            return;
        }

        const fileLinks = contract.contractFilesData.map((file, index) => {
            return `
                <a href="${file.viewUrl}" target="_blank" class="block w-full text-left p-3 mb-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-200">
                    <i class="fas fa-file-image text-teal-500 mr-2"></i> 
                    ไฟล์ที่ ${index + 1} (คลิกเพื่อดู)
                </a>
            `;
        }).join('');

        Swal.fire({
            title: `ไฟล์สัญญาของ ${contract.name}`,
            html: `
                <p class="mb-4 text-sm text-gray-600">รหัสสาขา: ${contract.branchId}</p>
                <div class="max-h-60 overflow-y-auto text-left">
                    ${fileLinks}
                </div>
            `,
            icon: 'info',
            confirmButtonText: 'ปิด',
            confirmButtonColor: '#26A69A'
        });
    }

    function renderContractsTable(contracts) {
        const tableBody = document.getElementById('contractsTable');
        tableBody.innerHTML = contracts.length === 0 ? '<tr><td colspan="10" class="text-center text-gray-500">ไม่มีข้อมูลสัญญา</td></tr>' :
            contracts.map(c => {
                
                let actions = '';

                if (c.contractFilesData && c.contractFilesData.length > 0) {
                    actions += `<button onclick="viewContractFiles('${c.id}')" class="text-green-600 hover:text-green-800 mr-2" title="ดูไฟล์"><i class="fas fa-eye"></i></button>`;
                } else {
                    actions += `<span class="text-gray-400 mr-2" title="ไม่มีไฟล์"><i class="fas fa-eye-slash"></i></span>`;
                }
                if (CONFIG.currentUser.canEdit) {
                    actions += `<button onclick="editContract('${c.id}')" class="text-blue-600 hover:text-blue-800 mr-2" title="แก้ไข"><i class="fas fa-edit"></i></button>`;
                }
                if (CONFIG.currentUser.canDelete) {
                    actions += `<button onclick="deleteContract('${c.id}')" class="text-red-600 hover:text-red-800" title="ลบ"><i class="fas fa-trash"></i></button>`;
                }

                return `<tr><td>${c.branchId}</td><td>${c.name}</td><td>${c.regional}</td><td>${c.district}</td><td class="text-center">${c.unitCount}</td><td>${format.date(c.startDate)}</td><td>${format.date(c.endDate)}</td><td>${format.currency(c.monthlyRent)}</td><td>${getStatusBadge(getContractStatus(c.endDate))}</td><td>${actions || 'ไม่มีสิทธิ์'}</td></tr>`;
            }).join('');
    }
    
    function renderLogsTable(logs) {
        const tableBody = document.getElementById('logsTable');
        tableBody.innerHTML = logs.length ? 
            logs.map(log => `<tr><td>${log.timestamp ? new Date(log.timestamp).toLocaleString('th-TH') : ''}</td><td>${log.user}</td><td>${log.activity}</td><td>${log.details}</td></tr>`).join('') : 
            `<tr><td colspan="4" class="text-center text-gray-500">ไม่พบข้อมูล Log ในช่วงเวลาที่เลือก</td></tr>`;
    }

    function renderUsersTable(users) {
        document.getElementById('usersTable').innerHTML = users.length ? users.map(user => `<tr>
            <td>${user.username}</td><td>${user.name}</td><td>${user.role}</td><td>${user.permissionArea}</td>
            <td class="text-center">${user.canAdd ? '<i class="fas fa-check text-green-500"></i>' : '<i class="fas fa-times text-red-500"></i>'}</td>
            <td class="text-center">${user.canEdit ? '<i class="fas fa-check text-green-500"></i>' : '<i class="fas fa-times text-red-500"></i>'}</td>
            <td class="text-center">${user.canDelete ? '<i class="fas fa-check text-green-500"></i>' : '<i class="fas fa-times text-red-500"></i>'}</td>
            <td><button onclick="editUser('${user.username}')" class="text-blue-600 hover:text-blue-800 mr-2"><i class="fas fa-edit"></i></button>
                <button onclick="deleteUser('${user.username}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button></td>
        </tr>`).join('') : `<tr><td colspan="8" class="text-center text-gray-500">ไม่พบข้อมูลผู้ใช้</td></tr>`;
    }

    function filterUsers() {
        const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
        if (!CONFIG.users) return;
        
        const filtered = CONFIG.users.filter(user => 
            (user.name && user.name.toLowerCase().includes(searchTerm)) ||
            (user.username && user.username.toLowerCase().includes(searchTerm))
        );
        renderUsersTable(filtered);
    }

    function filterContracts() {
        const filters = {
            district: document.getElementById('filterDistrict').value.toLowerCase(),
            branch: document.getElementById('filterBranch').value.toLowerCase(),
            status: document.getElementById('filterStatus').value
        };
        const filtered = CONFIG.contracts.filter(c => 
            (!filters.district || c.district.toLowerCase().includes(filters.district)) &&
            (!filters.branch || c.branchId.toLowerCase().includes(filters.branch)) &&
            (!filters.status || getContractStatus(c.endDate) === filters.status)
        );
        renderContractsTable(filtered);
    }
    function filterLogs() {
        const startDateValue = document.getElementById('logStartDate').value;
        const endDateValue = document.getElementById('logEndDate').value;
        const filteredLogs = CONFIG.logs.filter(log => {
            if (!log.timestamp) return false;
            const logDate = new Date(log.timestamp);
            const start = startDateValue ? new Date(startDateValue) : null;
            const end = endDateValue ? new Date(endDateValue) : null;
            if (start && logDate < start) return false;
            if (end && logDate > end) return false;
            return true;
        });
        renderLogsTable(filteredLogs);
    }
    function resetLogFilter() {
        document.getElementById('logStartDate').value = '';
        document.getElementById('logEndDate').value = '';
        renderLogsTable(CONFIG.logs);
    }
    function editContract(id) {
        const contract = CONFIG.contracts.find(c => c.id === id); if (!contract) return;
        fileManager.resetEdit();
        fileManager.edit.existing = [...contract.contractFilesData];
        
        const form = document.getElementById('editContractForm');
        form.id.value = contract.id; form.branchId.value = contract.branchId; form.name.value = contract.name;
        form.regional.value = contract.regional; form.district.value = contract.district; 
        form.unitCount.value = contract.unitCount; 
        form.startDate.value = contract.startDate; form.endDate.value = contract.endDate; form.monthlyRent.value = contract.monthlyRent;
        
        renderFilePreviews('edit');
        document.getElementById('editModal').classList.add('active');
    }
    async function deleteContract(id) {
        const contract = CONFIG.contracts.find(c => c.id === id); if (!contract) return;
        const result = await Swal.fire({ title: 'ยืนยันการลบ', text: `คุณต้องการลบสัญญาของ ${contract.name} ใช่หรือไม่?`, icon: 'warning', showCancelButton: true, confirmButtonText: 'ลบ', cancelButtonText: 'ยกเลิก', confirmButtonColor: '#d33', cancelButtonColor: '#6c757d' });
        if (result.isConfirmed) {
            UI.showLoading();
            try { 
                await api.deleteContract(id); 
                UI.showToast('ลบสัญญาสำเร็จ!'); 
                await loadContractsPage(); 
            } catch (error) { UI.showToast(`ลบไม่สำเร็จ: ${error.message}`, 'error');
            } finally { UI.hideLoading(); }
        }
    }
    function editUser(username) {
        const user = CONFIG.users.find(u => u.username === username); if (!user) return;
        const form = document.getElementById('editUserForm');
        form.originalUsername.value = user.username; form.username.value = user.username; form.name.value = user.name;
        form.role.value = user.role; form.permissionArea.value = user.permissionArea;
        form.canAdd.checked = user.canAdd; form.canEdit.checked = user.canEdit; form.canDelete.checked = user.canDelete;
        document.getElementById('editUserModal').classList.add('active');
    }
    async function deleteUser(username) {
        if (CONFIG.currentUser.username === username) { UI.showToast('ไม่สามารถลบตัวเองได้', 'error'); return; }
        const user = CONFIG.users.find(u => u.username === username); if (!user) return;
        const result = await Swal.fire({ title: 'ยืนยันการลบ', text: `คุณต้องการลบผู้ใช้ ${user.name}?`, icon: 'warning', showCancelButton: true, confirmButtonText: 'ลบ', cancelButtonText: 'ยกเลิก', confirmButtonColor: '#d33', cancelButtonColor: '#6c757d' });
        if (result.isConfirmed) {
            UI.showLoading();
            try { 
                await api.deleteUser(username); 
                UI.showToast('ลบผู้ใช้สำเร็จ!'); 
                await loadUsersPage(); 
            } catch (error) { UI.showToast(`ลบไม่สำเร็จ: ${error.message}`, 'error'); 
            } finally { UI.hideLoading(); }
        }
    }

    const pageLoaders = { 
        dashboard: loadDashboard, 
        contracts: loadContractsPage, 
        logs: loadLogsPage, 
        users: loadUsersPage, 
        reports: loadReportsPage, 
        notifications: loadNotificationsPage 
    };

    function getActivePage() {
        const activePage = document.querySelector('.page-content:not(.hidden)');
        return activePage ? activePage.id.replace('Page', '') : 'dashboard';
    }

    function navigateToPage(pageName) {
        // ปิดเมนูมือถืออัตโนมัติเมื่อคลิก
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('sidebarBackdrop');
        if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
            sidebar.classList.add('-translate-x-full');
            backdrop.classList.add('hidden');
        }

        document.querySelectorAll('.page-content').forEach(p => {
            p.classList.add('hidden');
            p.classList.remove('animate-page-load');
        });
        document.querySelectorAll('.sidebar-menu-item').forEach(i => i.classList.remove('active'));
        const targetPage = document.getElementById(`${pageName}Page`);
        if (targetPage) {
            if (pageName === 'addContract') {
                document.getElementById('addContractForm').reset();
                fileManager.resetAdd();
                renderFilePreviews('add');
            }
            targetPage.classList.remove('hidden');
            const targetMenuItem = document.querySelector(`[data-page="${pageName}"]`);
            if(targetMenuItem) targetMenuItem.classList.add('active');
            
            if(pageLoaders[pageName]) pageLoaders[pageName]();
        }
    }
    
    function getFilesAsBase64(files) {
        if (!files || files.length === 0) return Promise.resolve([]);
        return Promise.all(Array.from(files).map(file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        })));
    }

    function renderFilePreviews(mode) {
        const isAdd = mode === 'add';
        const container = document.getElementById(isAdd ? 'addFilesPreviewsContainer' : 'editCurrentFilesContainer');
        const newFileContainer = document.getElementById('editFilesPreviewsContainer');
        const fileLabel = document.getElementById(isAdd ? 'addContractFileLabel' : 'editContractFileLabel');

        container.innerHTML = '';
        if (newFileContainer) newFileContainer.innerHTML = '';

        let totalFiles = 0;
        if (isAdd) {
            totalFiles = fileManager.add.length;
            fileManager.add.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = e => {
                    container.innerHTML += `<div class="file-preview-item"><img src="${e.target.result}" alt="preview"><button type="button" class="remove-file-btn" data-mode="add" data-index="${index}">&times;</button></div>`;
                };
                reader.readAsDataURL(file);
            });
        } else {
            totalFiles = fileManager.edit.existing.length + fileManager.edit.new.length;
            fileManager.edit.existing.forEach((file, index) => {
                container.innerHTML += `<div class="file-preview-item"><a href="${file.viewUrl}" target="_blank"><img src="${file.viewUrl}" alt="existing file"></a><button type="button" class="remove-file-btn" data-mode="edit" data-type="existing" data-index="${index}">&times;</button></div>`;
            });
            fileManager.edit.new.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = e => {
                    newFileContainer.innerHTML += `<div class="file-preview-item"><img src="${e.target.result}" alt="preview"><button type="button" class="remove-file-btn" data-mode="edit" data-type="new" data-index="${index}">&times;</button></div>`;
                };
                reader.readAsDataURL(file);
            });
        }
        
        fileLabel.style.display = totalFiles >= 5 ? 'none' : 'flex';
        if (totalFiles < 5) {
            fileLabel.querySelector('span').textContent = `เพิ่มไฟล์ (${totalFiles}/5)...`;
        }
    }
    
    function handleFileSelection(e, mode) {
        const isAdd = mode === 'add';
        const currentFiles = isAdd ? fileManager.add : fileManager.edit.new;
        const existingFileCount = isAdd ? 0 : fileManager.edit.existing.length;
        const files = Array.from(e.target.files);
        const totalAfterAdd = currentFiles.length + existingFileCount + files.length;

        if (totalAfterAdd > 5) {
            UI.showToast(`เลือกไฟล์ได้สูงสุด 5 ไฟล์ (ปัจจุบันมี ${currentFiles.length + existingFileCount} ไฟล์)`, 'error');
        } else {
            currentFiles.push(...files);
        }
        e.target.value = '';
        renderFilePreviews(mode);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            CONFIG.currentUser = JSON.parse(savedUser);
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('currentUserDisplayHeader').textContent = CONFIG.currentUser.name || CONFIG.currentUser.username;
            document.getElementById('currentUserRoleHeader').textContent = CONFIG.currentUser.role || 'User';
            
            UI.updateVisibility();
            loadDashboard();
        }

        checkSidebarState(); 
        
        document.getElementById('sidebarToggleDesktop').addEventListener('click', toggleSidebarDesktop);
        document.getElementById('sidebarToggleMobile').addEventListener('click', toggleSidebarMobile);
        document.getElementById('sidebarBackdrop').addEventListener('click', toggleSidebarMobile);

        document.getElementById('loginForm').addEventListener('submit', e => { e.preventDefault(); login(document.getElementById('username').value, document.getElementById('password').value); });
        
        document.getElementById('logoutBtn').addEventListener('click', e => { e.preventDefault(); logout(); });
        document.querySelectorAll('[data-page]').forEach(el => el.addEventListener('click', e => { e.preventDefault(); navigateToPage(el.getAttribute('data-page')); }));
        
        document.getElementById('notificationBell').addEventListener('click', () => { 
            loadNotificationDropdown(); 
            document.getElementById('notificationDropdown').classList.toggle('hidden');
            document.getElementById('userDropdown').classList.add('hidden');
        });
        
        document.getElementById('userMenuButton').addEventListener('click', () => {
            document.getElementById('userDropdown').classList.toggle('hidden');
            document.getElementById('notificationDropdown').classList.add('hidden');
        });

        document.getElementById('refreshDataBtn').addEventListener('click', () => {
            const currentPageId = getActivePage();
            if (pageLoaders[currentPageId]) {
                UI.showToast('กำลังรีเฟรชข้อมูล...', 'success');
                
                const icon = document.querySelector('#refreshDataBtn i');
                icon.classList.add('fa-spin'); 
                
                const currentPageElement = document.getElementById(`${currentPageId}Page`);
                if (currentPageElement) {
                    currentPageElement.classList.remove('animate-page-load');
                }
                
                pageLoaders[currentPageId]()
                    .finally(() => {
                        setTimeout(() => {
                            icon.classList.remove('fa-spin');
                        }, 500);
                    });
            }
        });
        
        document.addEventListener('click', e => {
            const bell = document.getElementById('notificationBell');
            const notificationDropdown = document.getElementById('notificationDropdown');
            const userMenuButton = document.getElementById('userMenuButton');
            const userDropdown = document.getElementById('userDropdown');
            const mobileToggleBtn = document.getElementById('sidebarToggleMobile');

            if (!notificationDropdown.classList.contains('hidden') && !bell.contains(e.target) && !notificationDropdown.contains(e.target) && !e.target.closest('#notificationBell')) {
                notificationDropdown.classList.add('hidden');
            }
            
            if (!userDropdown.classList.contains('hidden') && !userMenuButton.contains(e.target) && !userDropdown.contains(e.target) && !e.target.closest('#userMenuButton') && !mobileToggleBtn.contains(e.target)) {
                userDropdown.classList.add('hidden');
            }

            if (e.target.matches('.remove-file-btn')) {
                e.preventDefault();
                const { mode, index, type } = e.target.dataset;
                const idx = parseInt(index);
                if (mode === 'add') {
                    fileManager.add.splice(idx, 1);
                } else if (mode === 'edit') {
                    if (type === 'new') {
                        fileManager.edit.new.splice(idx, 1);
                    } else if (type === 'existing') {
                        const removedFile = fileManager.edit.existing.splice(idx, 1)[0];
                        if(removedFile) fileManager.edit.toDelete.push(removedFile.originalUrl);
                    }
                }
                renderFilePreviews(mode);
            }
        });

        ['filterDistrict', 'filterBranch', 'filterStatus'].forEach(id => document.getElementById(id).addEventListener('input', filterContracts));
        document.getElementById('filterLogsBtn')?.addEventListener('click', filterLogs);
        document.getElementById('resetLogsBtn')?.addEventListener('click', resetLogFilter);

        document.getElementById('userSearchInput')?.addEventListener('input', filterUsers);

        const setupModal = (m, o, c) => { if(o) document.getElementById(o).addEventListener('click', () => document.getElementById(m).classList.add('active')); c.forEach(id => document.getElementById(id).addEventListener('click', () => document.getElementById(m).classList.remove('active'))); };
        setupModal('addUserModal', 'addUserBtn', ['closeAddUserModal', 'cancelAddUser']);
        setupModal('editUserModal', null, ['closeEditUserModal', 'cancelEditUser']);
        setupModal('editModal', null, ['closeEditModal', 'cancelEdit']);
        setupModal('changePasswordModal', 'changePasswordBtn', ['closeChangePasswordModal', 'cancelChangePassword']);

        document.getElementById('addContractForm').addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังบันทึก...';
            try {
                const formData = Object.fromEntries(new FormData(e.target));
                formData.contractFilesData = await getFilesAsBase64(fileManager.add);
                await api.addContract(formData);
                UI.showToast('เพิ่มสัญญาสำเร็จ!');
                e.target.reset(); navigateToPage('contracts');
            } catch (error) { 
                UI.showToast(`เพิ่มสัญญาไม่สำเร็จ: ${error.message}`, 'error');
            } finally { 
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-save mr-2"></i>บันทึกสัญญา';
            }
        });

        document.getElementById('editContractForm').addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังบันทึก...';
            try {
                const formData = Object.fromEntries(new FormData(e.target));
                formData.contractFilesData = await getFilesAsBase64(fileManager.edit.new);
                formData.filesToDelete = fileManager.edit.toDelete;
                await api.updateContract(formData);
                UI.showToast('แก้ไขสัญญาสำเร็จ!');
                document.getElementById('editModal').classList.remove('active');
                await loadContractsPage();
            } catch (error) { 
                UI.showToast(`แก้ไขสัญญาไม่สำเร็จ: ${error.message}`, 'error');
            } finally { 
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-save mr-2"></i>บันทึก';
            }
        });
        
        document.getElementById('addUserForm').addEventListener('submit', async e => { 
            e.preventDefault(); 
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังบันทึก...';
            try {
                const fd = new FormData(e.target); const d = Object.fromEntries(fd); 
                d.canAdd = fd.has('canAdd'); d.canEdit = fd.has('canEdit'); d.canDelete = fd.has('canDelete');
                await api.addUser(d);
                UI.showToast('เพิ่มผู้ใช้สำเร็จ!');
                document.getElementById('addUserModal').classList.remove('active'); e.target.reset(); await loadUsersPage();
            } catch(error) { 
                UI.showToast(`เพิ่มผู้ใช้ไม่สำเร็จ: ${error.message}`, 'error');
            } finally { 
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-save mr-2"></i>บันทึก';
            }
        });
        document.getElementById('editUserForm').addEventListener('submit', async e => { 
            e.preventDefault(); 
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังบันทึก...';
            try {
                const fd = new FormData(e.target); const d = Object.fromEntries(fd); 
                d.canAdd = fd.has('canAdd'); d.canEdit = fd.has('canEdit'); d.canDelete = fd.has('canDelete');
                await api.updateUser(d);
                UI.showToast('แก้ไขผู้ใช้สำเร็จ!');
                document.getElementById('editUserModal').classList.remove('active'); await loadUsersPage();
            } catch(error) { 
                UI.showToast(`แก้ไขผู้ใช้ไม่สำเร็จ: ${error.message}`, 'error');
            } finally { 
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-save mr-2"></i>บันทึก';
            }
        });

        document.getElementById('changePasswordForm').addEventListener('submit', async e => {
            e.preventDefault();
            const form = e.target;
            const fd = new FormData(form);
            const data = Object.fromEntries(fd);

            if (data.newPassword !== data.confirmPassword) {
                UI.showToast('รหัสผ่านใหม่และการยืนยันไม่ตรงกัน', 'error');
                return;
            }

            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังบันทึก...';
            
            try {
                const { message } = await api.changePassword({ 
                    oldPassword: data.oldPassword, 
                    newPassword: data.newPassword 
                });
                UI.showToast(message || 'เปลี่ยนรหัสผ่านสำเร็จ!', 'success');
                document.getElementById('changePasswordModal').classList.remove('active');
                form.reset();
            } catch (error) {
                UI.showToast(error.message || 'เกิดข้อผิดพลาด', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-key mr-2"></i>ยืนยันการเปลี่ยนแปลง';
            }
        });

        document.getElementById('addContractFiles').addEventListener('change', e => handleFileSelection(e, 'add'));
        document.getElementById('editContractFiles').addEventListener('change', e => handleFileSelection(e, 'edit'));
    });
  </script>
 </body>
</html>
