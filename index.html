<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการสัญญาเช่าอัจฉริยะ</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        /* CSS is identical to the previous "Corporate & Bold" theme */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        :root {
            --primary-color: #003092;
            --accent-color: #FF4F0F;
            --success-color: #06923E;
            --warning-color: #FCC737;
            --danger-color: #d91e18;
            --primary-gradient: linear-gradient(45deg, #003092, #0048d8);
            --accent-gradient: linear-gradient(45deg, #FF4F0F, #ff713b);
            --primary-color-light: rgba(0, 48, 146, 0.1);
            --sidebar-bg: #003092;
            --body-bg: #f0f4f9;
            --card-bg: #ffffff;
            --text-dark: #1e293b;
            --text-light: #ffffff;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --border-radius-xl: 0.75rem;
            --border-radius-md: 0.5rem;
            --soft-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            --hover-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        body { font-family: 'Kanit', sans-serif; background-color: var(--body-bg); color: var(--text-dark); }
        #login-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; background-color: var(--body-bg); }
        .login-box { border-radius: var(--border-radius-xl); width: 100%; max-width: 400px; padding: 2.5rem; background: var(--card-bg); box-shadow: var(--hover-shadow); animation: fadeIn 0.5s ease-out; border: 1px solid var(--border-color); }
        .login-box h2 { color: var(--primary-color); }
        #app-wrapper { display: flex; }
        #sidebar { width: 250px; background-color: var(--sidebar-bg); color: var(--text-light); min-height: 100vh; border-right: 1px solid var(--border-color); transition: width 0.3s ease; }
        .sidebar-header { padding: 20px; text-align: center; background-color: rgba(0,0,0,0.1); }
        .sidebar-header h3 { margin: 0; font-size: 1.6rem; font-weight: 600; color: var(--text-light); }
        .sidebar-menu { list-style: none; padding: 1rem 0; }
        .sidebar-menu li a { display: flex; align-items: center; padding: 14px 25px; margin: 5px 15px; color: rgba(255, 255, 255, 0.7); text-decoration: none; transition: all 0.3s ease; border-radius: var(--border-radius-md); font-weight: 500; }
        .sidebar-menu li a:hover { background-color: rgba(0,0,0,0.2); color: var(--text-light); }
        .sidebar-menu li a.active { background: var(--accent-gradient); color: #fff; box-shadow: 0 4px 10px -2px rgba(255, 79, 15, 0.4); }
        .sidebar-menu li a .material-icons { margin-right: 15px; }
        #content-wrapper { flex-grow: 1; }
        .topbar { background: var(--card-bg); padding: 10px 30px; display: flex; justify-content: flex-end; align-items: center; border-bottom: 1px solid var(--border-color); }
        main { padding: 2.5rem; }
        .page-header h1 { font-weight: 700; font-size: 2.2rem; color: var(--primary-color); }
        .page-content { display: none; }
        .page-content.active { display: block; animation: fadeIn 0.4s ease-out; }
        .card { border: 1px solid var(--border-color); border-radius: var(--border-radius-xl); box-shadow: var(--soft-shadow); background-color: var(--card-bg); transition: all 0.3s ease; }
        .summary-card:hover { transform: translateY(-5px); box-shadow: var(--hover-shadow); border-color: var(--primary-color); }
        .summary-card.clickable { cursor: pointer; }
        .summary-card .icon-circle { width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1.25rem; font-size: 28px; }
        h4.card-title { font-weight: 700; font-size: 1.75rem; color: var(--text-dark); }
        .card-title.loading { width: 70px; height: 1.75rem; border-radius: 6px; animation: skeleton-loading 1s linear infinite alternate; }
        @keyframes skeleton-loading { 0% { background-color: hsl(200, 20%, 80%); } 100% { background-color: hsl(200, 20%, 95%); } }
        .btn { border-radius: var(--border-radius-md); font-weight: 600; padding: 0.6rem 1.2rem; transition: all 0.2s ease-in-out; border: none; }
        .btn-primary { background: var(--accent-gradient); color: #fff; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px -5px rgba(255, 79, 15, 0.5); }
        .form-control, .form-select { border-radius: var(--border-radius-md); border: 1px solid var(--border-color); padding: 0.75rem 1rem; }
        .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem var(--primary-color-light); }
        .form-control:read-only { background-color: #f1f5f9; }
        .bg-primary-light { background-color: #e0e9fe; color: var(--primary-color); }
        .bg-success-light { background-color: #d9f9e5; color: var(--success-color); }
        .bg-warning-light { background-color: #fff8e3; color: #e9b30f; }
        .bg-danger-light { background-color: #ffe5e4; color: var(--danger-color); }
        .table thead th { background-color: #f8fafc; color: var(--text-muted); }
        .table-hover tbody tr:hover { background-color: #f5f8ff; box-shadow: var(--hover-shadow); position: relative; z-index: 2; transform: scale(1.01); }
        .table-hover tbody tr:hover td { background: transparent; }
        .status-badge { padding: 0.4em 0.9em; font-size: 0.8rem; font-weight: 500; border-radius: 50rem; }
        .status-normal { background-color: var(--success-color); color: white; }
        .status-warning { background-color: var(--warning-color); color: #413207; }
        .status-expired { background-color: var(--danger-color); color: white; }
        .sortable { cursor: pointer; position: relative; padding-right: 35px !important; }
        .sort-icon { position: absolute; right: 1.25rem; top: 50%; transform: translateY(-50%); font-size: 1.4rem; color: #94a3b8; }
        .sortable:hover .sort-icon { color: var(--text-dark); }
        .sortable.asc .sort-icon, .sortable.desc .sort-icon { color: var(--primary-color); }
        .modal-content { border-radius: var(--border-radius-xl); border: none; box-shadow: var(--hover-shadow); }
        .swal2-popup { border-radius: var(--border-radius-xl) !important; font-family: 'Kanit', sans-serif !important; box-shadow: var(--hover-shadow) !important; }
        .swal2-confirm { background: var(--accent-gradient) !important; border:0; border-radius: var(--border-radius-md) !important; }
    </style>
</head>
<body>

    <!-- HTML is identical, only JS has changes. -->
    <div id="login-page"> <div class="login-box text-center"> <h2 class="mb-3">Smart Lease</h2> <p class="text-muted mb-4">ระบบจัดการสัญญาเช่า</p> <form id="login-form"> <div class="form-floating mb-3"><input type="email" class="form-control" id="email" placeholder="name@example.com" required autocomplete="email"></div> <div class="form-floating mb-3"><input type="password" class="form-control" id="password" placeholder="Password" required autocomplete="current-password"></div> <div id="login-error" class="text-danger mb-3 d-none"></div> <button type="button" id="login-button" class="btn btn-primary w-100 btn-lg">เข้าสู่ระบบ</button> </form> </div> </div>
    <div id="app-wrapper" class="d-none"> <nav id="sidebar"> <div class="sidebar-header"><h3>Smart Lease</h3></div> <ul class="sidebar-menu"> <li><a href="#dashboard" class="nav-link active"><i class="material-icons">dashboard</i><span>แดชบอร์ด</span></a></li> <li><a href="#contracts" class="nav-link"><i class="material-icons">description</i><span>จัดการสัญญา</span></a></li> <li id="menu-users" class="admin-only d-none"><a href="#users" class="nav-link"><i class="material-icons">group</i><span>จัดการผู้ใช้งาน</span></a></li> <li id="menu-logs" class="admin-only d-none"><a href="#logs" class="nav-link"><i class="material-icons">history</i><span>ประวัติการใช้งาน</span></a></li> </ul> </nav> <div id="content-wrapper"> <div class="topbar"> <div class="dropdown"> <a href="#" class="d-flex align-items-center text-dark text-decoration-none dropdown-toggle" id="dropdownUser" data-bs-toggle="dropdown" aria-expanded="false"> <div class="user-info me-2"> <span id="user-display-name" class="fw-bold">Username</span> <div id="user-display-role" class="user-role">Role</div> </div> </a> <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownUser"><li><a id="logout-button" class="dropdown-item" href="#">ออกจากระบบ</a></li></ul> </div> </div> <main> <div id="dashboard-content" class="page-content active"> <div class="page-header"><h1>แดชบอร์ด</h1><p class="text-muted" id="dashboard-subtitle"></p></div> <div> <div class="row g-4 mb-4"> <div class="col-md-6 col-lg-3"><div id="card-total" class="card summary-card clickable"><div class="card-body"><div class="icon-circle bg-primary-light"><i class="material-icons">description</i></div><div><h6 class="card-subtitle mb-2 text-muted">สัญญาทั้งหมด</h6><h4 class="card-title" id="total-contracts-card"></h4></div></div></div></div> <div class="col-md-6 col-lg-3"><div id="card-expiring" class="card summary-card clickable"><div class="card-body"><div class="icon-circle bg-warning-light"><i class="material-icons" style="color:#a27b07">warning</i></div><div><h6 class="card-subtitle mb-2 text-muted">ใกล้หมดอายุ (90 วัน)</h6><h4 class="card-title" id="expiring-contracts-card"></h4></div></div></div></div> <div class="col-md-6 col-lg-3"><div id="card-expired" class="card summary-card clickable"><div class="card-body"><div class="icon-circle bg-danger-light"><i class="material-icons">error</i></div><div><h6 class="card-subtitle mb-2 text-muted">สัญญาหมดอายุแล้ว</h6><h4 class="card-title" id="expired-contracts-card"></h4></div></div></div></div> <div class="col-md-6 col-lg-3"><div class="card summary-card"><div class="card-body"><div class="icon-circle bg-success-light"><i class="material-icons">attach_money</i></div><div><h6 class="card-subtitle mb-2 text-muted">ค่าเช่ารวม/เดือน</h6><h4 class="card-title" id="total-rent-card"></h4></div></div></div></div> </div> <div class="row"><div class="col-12"><div class="card"><div class="card-body"><h5 class="card-title">รายการสัญญาที่ต้องให้ความสนใจ</h5><div class="table-responsive"><table class="table table-hover"><thead><tr><th>สาขา</th><th>เขต</th><th>วันหมดอายุ</th><th>สถานะ</th><th class="text-end">ค่าเช่า/เดือน</th></tr></thead><tbody id="attention-list"></tbody></table></div></div></div></div></div> </div> </div> <div id="contracts-content" class="page-content"> <div class="page-header d-flex justify-content-between align-items-center"><h1>จัดการสัญญา</h1><button id="add-contract-btn" class="btn btn-primary writable-only d-none"><i class="material-icons align-middle me-1">add</i> เพิ่มสัญญาใหม่</button></div> <div class="card filter-card mb-4 border-0 shadow-none bg-transparent"><div class="row g-3 align-items-end"><div class="col-lg-4 col-md-12"><label for="contract-search-input" class="form-label">ค้นหา</label><input type="text" id="contract-search-input" class="form-control" placeholder="รหัสสาขา, ชื่อ, เขต..."></div><div class="col-lg-2 col-md-6"><label for="contract-status-filter" class="form-label">สถานะ</label><select id="contract-status-filter" class="form-select"><option value="">ทั้งหมด</option><option value="status-normal">ปกติ</option><option value="status-warning">ใกล้หมดอายุ</option><option value="status-expired">หมดอายุแล้ว</option></select></div><div class="col-lg-2 col-md-6"><label for="contract-start-date" class="form-label">วันสิ้นสุด (เริ่ม)</label><input type="date" id="contract-start-date" class="form-control"></div><div class="col-lg-2 col-md-6"><label for="contract-end-date" class="form-label">วันสิ้นสุด (ถึง)</label><input type="date" id="contract-end-date" class="form-control"></div><div class="col-lg-2 col-md-6"><button id="contract-clear-filter-btn" class="btn btn-outline-secondary w-100">ล้างตัวกรอง</button></div></div></div> <div class="card"><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover"> <thead><tr> <th class="sortable" data-sort="branchId">รหัสสาขา<i class="material-icons sort-icon">unfold_more</i></th> <th class="sortable" data-sort="name">ชื่อสาขา<i class="material-icons sort-icon">unfold_more</i></th> <th class="sortable" data-sort="district">เขต<i class="material-icons sort-icon">unfold_more</i></th> <th class="sortable" data-sort="startDate">วันเริ่มสัญญา<i class="material-icons sort-icon">unfold_more</i></th> <th class="sortable asc" data-sort="endDate">วันสิ้นสุดสัญญา<i class="material-icons sort-icon">expand_less</i></th> <th>สถานะแจ้งเตือน</th> <th class="writable-only d-none text-end">การกระทำ</th> </tr></thead> <tbody id="contracts-table-body"></tbody> </table></div></div></div> </div> <div id="users-content" class="page-content"> <div class="page-header d-flex justify-content-between align-items-center"><h1>จัดการผู้ใช้งาน</h1><button id="add-user-btn" class="btn btn-primary"><i class="material-icons align-middle me-1">add</i> เพิ่มผู้ใช้ใหม่</button></div> <div class="card filter-card mb-4 border-0 shadow-none bg-transparent"><div class="row g-3"><div class="col-md-6"><label for="user-search-input" class="form-label">ค้นหา (Email, ชื่อ)</label><input type="text" id="user-search-input" class="form-control" placeholder="พิมพ์เพื่อค้นหา..."></div><div class="col-md-6"><label for="user-role-filter" class="form-label">ตำแหน่ง (Role)</label><select id="user-role-filter" class="form-select"><option value="">ทั้งหมด</option><option value="Admin">Admin</option><option value="Regional Manager">Regional Manager</option><option value="District Manager">District Manager</option><option value="Employee">Employee</option></select></div></div></div> <div class="card"><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover"> <thead><tr> <th class="sortable asc" data-sort="email">Email<i class="material-icons sort-icon">expand_less</i></th> <th class="sortable" data-sort="name">ชื่อ<i class="material-icons sort-icon">unfold_more</i></th> <th class="sortable" data-sort="role">ตำแหน่ง (Role)<i class="material-icons sort-icon">unfold_more</i></th> <th class="sortable" data-sort="permissionArea">เขต/ภาคที่ดูแล<i class="material-icons sort-icon">unfold_more</i></th> <th class="text-end">การกระทำ</th> </tr></thead> <tbody id="users-table-body"></tbody> </table></div></div></div> </div> <div id="logs-content" class="page-content"> <div class="page-header"><h1>ประวัติการใช้งาน</h1></div> <div class="card filter-card mb-4 border-0 shadow-none bg-transparent"><div class="row g-3 align-items-end"><div class="col-md-5"><label for="log-search-input" class="form-label">ค้นหา (ผู้ใช้, กิจกรรม, รายละเอียด)</label><input type="text" id="log-search-input" class="form-control" placeholder="พิมพ์เพื่อค้นหา..."></div><div class="col-md-3"><label for="log-start-date" class="form-label">ตั้งแต่วันที่</label><input type="date" id="log-start-date" class="form-control"></div><div class="col-md-3"><label for="log-end-date" class="form-label">ถึงวันที่</label><input type="date" id="log-end-date" class="form-control"></div><div class="col-md-1"><button id="log-clear-filter-btn" class="btn btn-outline-secondary w-100">ล้าง</button></div></div></div> <div class="card"><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover"> <thead><tr> <th class="sortable desc" data-sort="timestamp">วันที่-เวลา<i class="material-icons sort-icon">expand_more</i></th> <th class="sortable" data-sort="user">ผู้ใช้งาน<i class="material-icons sort-icon">unfold_more</i></th> <th class="sortable" data-sort="activity">กิจกรรม<i class="material-icons sort-icon">unfold_more</i></th> <th>รายละเอียด</th> </tr></thead> <tbody id="logs-table-body"></tbody> </table></div></div></div> </div> </main> </div> </div>
    <div class="modal fade" id="contract-modal" tabindex="-1" aria-labelledby="contractModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"><h5 class="modal-title" id="contractModalLabel">ข้อมูลสัญญา</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div> <div class="modal-body"> <form id="contract-form" onsubmit="return false;"> <div class="row g-3"> <div class="col-md-4"><label for="form-contract-branchId" class="form-label">รหัสสาขา</label><input type="text" id="form-contract-branchId" class="form-control" required></div> <div class="col-md-8"><label for="form-contract-name" class="form-label">ชื่อสาขา</label><input type="text" id="form-contract-name" class="form-control" required></div> <div class="col-md-4"> <label for="form-contract-regional" class="form-label">ภาค</label> <input type="text" id="form-contract-regional" class="form-control" required readonly> </div> <div class="col-md-4"> <label for="form-contract-district" class="form-label">เขต</label> <select id="form-contract-district" class="form-select" required> <option value="">-- เลือกเขต --</option> <option value="K012">K012</option> <option value="K122">K122</option> <option value="K189">K189</option> <option value="K195">K195</option> <option value="K196">K196</option> <option value="K247">K247</option> <option value="K273">K273</option> <option value="K358">K358</option> </select> </div> <div class="col-md-4"><label for="form-contract-monthlyRent" class="form-label">ค่าเช่า/เดือน</label><input type="number" step="any" id="form-contract-monthlyRent" class="form-control" required></div> <div class="col-md-6"><label for="form-contract-startDate" class="form-label">วันเริ่มสัญญา</label><input type="date" id="form-contract-startDate" class="form-control" required></div> <div class="col-md-6"><label for="form-contract-endDate" class="form-label">วันสิ้นสุดสัญญา</label><input type="date" id="form-contract-endDate" class="form-control" required></div> </div> </form> </div> <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button><button type="button" class="btn btn-primary" id="save-contract-button">บันทึกข้อมูล</button></div> </div> </div> </div>
    <div class="modal fade" id="user-modal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="userModalLabel">ข้อมูลผู้ใช้งาน</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><form id="user-form" onsubmit="return false;"><div class="row g-3"><div class="col-md-6"><label for="form-user-email" class="form-label">Email</label><input type="email" id="form-user-email" class="form-control" required></div><div class="col-md-6"><label for="form-user-name" class="form-label">ชื่อ-นามสกุล</label><input type="text" id="form-user-name" class="form-control" required></div><div class="col-md-6"><label for="form-user-password" class="form-label">Password</label><input type="password" id="form-user-password" class="form-control" placeholder="เว้นว่างไว้หากไม่ต้องการเปลี่ยน"></div><div class="col-md-6"><label for="form-user-role" class="form-label">ตำแหน่ง (Role)</label><select id="form-user-role" class="form-select" required><option value="Employee">Employee</option><option value="District Manager">District Manager</option><option value="Regional Manager">Regional Manager</option><option value="Admin">Admin</option></select></div><div class="col-md-12"><label for="form-user-permissionArea" class="form-label">เขต/ภาคที่ดูแล (Permission Area)</label><input type="text" id="form-user-permissionArea" class="form-control" placeholder="เช่น K012, P026, หรือ ALL"></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button><button type="button" class="btn btn-primary" id="save-user-button">บันทึกข้อมูล</button></div></div></div></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxbjHZ49NfVCKlEz1l-t2F15TpbM5qcKMpsJOP7Bc5bvwE03aASy-Ba_j9V9OY5TcvN/exec";
            let currentUser = null, allContracts = [], allUsers = [], allLogs = [];
            let contractSort = { key: 'endDate', order: 'asc' }, userSort = { key: 'email', order: 'asc' };
            let contractModal, userModal;
            // ========== [FIX] ADDED STATE VARIABLE FOR DASHBOARD FILTERING ==========
            let initialContractFilter = null;

            // DOM Elements
            const loginPage = document.getElementById('login-page');
            const appWrapper = document.getElementById('app-wrapper');
            const logoutButton = document.getElementById('logout-button');
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page-content');

            // Reusable Functions
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true, didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer) } });
            const showSuccessToast = (message) => Toast.fire({ icon: 'success', title: message });
            const showErrorAlert = (message) => Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: message, confirmButtonColor: 'var(--danger-color)' });
            const showConfirmDialog = (title, text) => Swal.fire({ title: title, text: text, icon: 'warning', showCancelButton: true, confirmButtonColor: 'var(--danger-color)', cancelButtonColor: '#6c757d', confirmButtonText: 'ใช่, ดำเนินการ!', cancelButtonText: 'ยกเลิก' });
            
            const createTableLoader = (cols) => `<tr><td colspan="${cols}" class="text-center py-5"><div class="spinner-border" style="color: var(--primary-color);" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>`;
            const setCardPlaceholders = (loading) => {
                const cardTitles = ['total-contracts-card', 'expiring-contracts-card', 'expired-contracts-card', 'total-rent-card'];
                cardTitles.forEach(id => {
                    const el = document.getElementById(id);
                    if (loading) { el.textContent = ''; el.classList.add('loading'); } 
                    else { el.classList.remove('loading'); }
                });
            };

            // Inactivity Logout Logic
            let inactivityTimer;
            const WARNING_TIME = 58 * 60 * 1000;
            const LOGOUT_COUNTDOWN = 2 * 60 * 1000;
            function showInactivityWarning() { let timerInterval; Swal.fire({ title: 'คุณยังอยู่หรือไม่?', html: `ระบบจะทำการออกจากระบบอัตโนมัติใน <b></b> วินาที`, icon: 'warning', timer: LOGOUT_COUNTDOWN, timerProgressBar: true, showConfirmButton: true, confirmButtonText: 'ใช้งานต่อ', confirmButtonColor: 'var(--success-color)', allowOutsideClick: false, didOpen: () => { const b = Swal.getHtmlContainer().querySelector('b'); timerInterval = setInterval(() => { b.textContent = Math.ceil(Swal.getTimerLeft() / 1000); }, 100); }, willClose: () => { clearInterval(timerInterval); } }).then((result) => { if (result.isConfirmed) { resetInactivityTimer(); } else if (result.dismiss === Swal.DismissReason.timer) { handleLogout({ preventDefault: () => {} }); } }); }
            function resetInactivityTimer() { clearTimeout(inactivityTimer); Swal.close(); inactivityTimer = setTimeout(showInactivityWarning, WARNING_TIME); }
            function setupInactivityListeners() { ['mousemove', 'mousedown', 'keypress', 'scroll'].forEach(event => document.addEventListener(event, resetInactivityTimer, true)); }
            function clearInactivityListeners() { clearTimeout(inactivityTimer); ['mousemove', 'mousedown', 'keypress', 'scroll'].forEach(event => document.removeEventListener(event, resetInactivityTimer, true)); }
            
            // Google Apps Script Communication
            function fetchDataFromGAS(action, params = {}) { params.userEmail = currentUser ? currentUser.email : 'ANONYMOUS'; const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random()); return new Promise((resolve, reject) => { window[callbackName] = (data) => { delete window[callbackName]; document.body.removeChild(script); if (data.success) { resolve(data.data); } else { reject(data.message || 'An unknown error occurred.'); } }; const queryString = new URLSearchParams({ ...params, action, callback: callbackName }).toString(); const script = document.createElement('script'); script.src = `${SCRIPT_URL}?${queryString}`; script.onerror = () => { reject('Network error.'); }; document.body.appendChild(script); }); }
            const postDataToGAS = (action, payload) => fetchDataFromGAS(action, { payload: JSON.stringify(payload) });

            // Authentication & Session
            function handleLogin() { const loginButton = document.getElementById('login-button'); const originalButtonText = loginButton.innerHTML; const email = document.getElementById('email').value; const password = document.getElementById('password').value; const loginError = document.getElementById('login-error'); loginError.classList.add('d-none'); if (!email || !password) { loginError.textContent = "กรุณากรอก Email และ Password"; loginError.classList.remove('d-none'); return; } loginButton.disabled = true; loginButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังตรวจสอบ...`; fetchDataFromGAS('loginUser', { email, password }).then(user => { currentUser = user; sessionStorage.setItem('currentUser', JSON.stringify(user)); showApp(); }).catch(error => { loginError.textContent = error; loginError.classList.remove('d-none'); }).finally(() => { loginButton.disabled = false; loginButton.innerHTML = originalButtonText; }); }
            function handleLogout(e) { e.preventDefault(); currentUser = null; sessionStorage.removeItem('currentUser'); clearInactivityListeners(); loginPage.style.display = 'flex'; appWrapper.classList.add('d-none'); }
            function checkSession() { const userJson = sessionStorage.getItem('currentUser'); if (userJson) { currentUser = JSON.parse(userJson); showApp(); } }

            // UI & Page Management
            function showPage(pageIdToShow) { pages.forEach(page => page.classList.remove('active')); const activePage = document.getElementById(pageIdToShow); if (activePage) { activePage.classList.add('active'); loadDataForPage(pageIdToShow); } }
            function showApp() { loginPage.style.display = 'none'; appWrapper.classList.remove('d-none'); document.getElementById('user-display-name').textContent = currentUser.name; document.getElementById('user-display-role').textContent = currentUser.role; updateUIForRole(); showPage('dashboard-content'); setupInactivityListeners(); resetInactivityTimer(); }
            function updateUIForRole() { document.querySelectorAll('.admin-only, .writable-only').forEach(el => el.classList.add('d-none')); if (currentUser.role === 'Admin') { document.querySelectorAll('.admin-only, .writable-only').forEach(el => el.classList.remove('d-none')); } else if (currentUser.role === 'Regional Manager' || currentUser.role === 'District Manager') { document.querySelectorAll('.writable-only').forEach(el => el.classList.remove('d-none')); } let subtitle = 'ภาพรวมข้อมูลสัญญาเช่า'; if (currentUser.role !== 'Admin') { subtitle += ` (เขต/ภาค: ${currentUser.permissionArea})`; } document.getElementById('dashboard-subtitle').textContent = subtitle; }
            
            // ========== [FIX] REWRITTEN NAVIGATION FUNCTION ==========
            function navigateToContractsAndFilter(filterValue) {
                initialContractFilter = filterValue; // Set the state before navigating
                document.querySelector('a.nav-link[href="#contracts"]').click();
            }
            
            // Data Loading & Rendering
            function loadDataForPage(pageId) { switch (pageId) { case 'dashboard-content': loadDashboardData(); break; case 'contracts-content': loadContractsData(); break; case 'users-content': if (currentUser.role === 'Admin') loadUsersData(); break; case 'logs-content': if (currentUser.role === 'Admin') loadLogsData(); break; } }
            function getStatus(endDateStr) { if (!endDateStr) return { text: 'N/A', class: '' }; const endDate = new Date(endDateStr); const now = new Date(); const diffDays = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24)); if (diffDays < 0) return { text: 'หมดอายุแล้ว', class: 'status-expired' }; if (diffDays <= 90) return { text: 'ใกล้หมดอายุ', class: 'status-warning' }; return { text: 'ปกติ', class: 'status-normal' }; }
            function formatThaiDate(dateString) { if (!dateString || typeof dateString !== 'string') return ""; const thaiMonths = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."]; const date = new Date(dateString); if (isNaN(date.getTime())) return dateString; return `${date.getDate()} ${thaiMonths[date.getMonth()]} ${date.getFullYear() + 543}`; }
            function loadDashboardData() { const attentionListEl = document.getElementById('attention-list'); attentionListEl.innerHTML = createTableLoader(5); setCardPlaceholders(true); fetchDataFromGAS('getContracts', { role: currentUser.role, permissionArea: currentUser.permissionArea }).then(contracts => { setCardPlaceholders(false); document.getElementById('total-contracts-card').textContent = contracts.length; document.getElementById('expiring-contracts-card').textContent = contracts.filter(c => getStatus(c.endDate).class === 'status-warning').length; document.getElementById('expired-contracts-card').textContent = contracts.filter(c => getStatus(c.endDate).class === 'status-expired').length; const totalRent = contracts.reduce((sum, c) => sum + (parseFloat(c.monthlyRent) || 0), 0); document.getElementById('total-rent-card').textContent = `฿${totalRent.toLocaleString()}`; attentionListEl.innerHTML = ''; const attentionContracts = contracts.filter(c => getStatus(c.endDate).class !== 'status-normal').sort((a, b) => new Date(a.endDate) - new Date(b.endDate)); if (attentionContracts.length > 0) { attentionContracts.forEach(c => { const status = getStatus(c.endDate); const rent = parseFloat(c.monthlyRent) || 0; attentionListEl.innerHTML += `<tr><td>${c.name}</td><td>${c.district}</td><td>${formatThaiDate(c.endDate)}</td><td><span class="status-badge ${status.class}">${status.text}</span></td><td class="text-end">฿${rent.toLocaleString()}</td></tr>`; }); } else { attentionListEl.innerHTML = `<tr><td colspan="5" class="text-center text-muted">ไม่พบสัญญาที่ต้องให้ความสนใจ</td></tr>`; } }).catch(error => { setCardPlaceholders(false); showErrorAlert(`เกิดข้อผิดพลาดในการโหลดข้อมูลแดชบอร์ด: ${error}`); attentionListEl.innerHTML = `<tr><td colspan="5" class="text-center text-danger">โหลดข้อมูลล้มเหลว</td></tr>`; }); }
            
            // ========== [FIX] MODIFIED DATA LOADING TO USE THE STATE VARIABLE ==========
            function loadContractsData() {
                const tableBody = document.getElementById('contracts-table-body');
                tableBody.innerHTML = createTableLoader(7);
                fetchDataFromGAS('getContracts', { role: currentUser.role, permissionArea: currentUser.permissionArea }).then(contracts => {
                    allContracts = contracts;
                    if (initialContractFilter !== null) {
                        document.getElementById('contract-status-filter').value = initialContractFilter;
                        initialContractFilter = null; // Clear after use
                    }
                    applyContractFilters();
                }).catch(error => tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">เกิดข้อผิดพลาด: ${error}</td></tr>`);
            }
            function loadUsersData() { const tableBody = document.getElementById('users-table-body'); tableBody.innerHTML = createTableLoader(5); fetchDataFromGAS('getUsers').then(users => { allUsers = users; applyUserFilters(); }).catch(error => tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">เกิดข้อผิดพลาด: ${error}</td></tr>`); }
            function loadLogsData() { const tableBody = document.getElementById('logs-table-body'); tableBody.innerHTML = createTableLoader(4); fetchDataFromGAS('getActivityLog').then(logs => { allLogs = logs; applyLogFilters(); }).catch(error => tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">เกิดข้อผิดพลาด: ${error}</td></tr>`); }
            
            function renderContractsTable(contracts) { const sortedContracts = [...contracts].sort((a, b) => { let valA = a[contractSort.key], valB = b[contractSort.key]; if (contractSort.key === 'startDate' || contractSort.key === 'endDate') { valA = new Date(valA); valB = new Date(valB); } if (valA < valB) return contractSort.order === 'asc' ? -1 : 1; if (valA > valB) return contractSort.order === 'asc' ? 1 : -1; return 0; }); const tableBody = document.getElementById('contracts-table-body'); tableBody.innerHTML = ''; if (sortedContracts.length === 0) { tableBody.innerHTML = '<tr><td colspan="7" class="text-center">ไม่พบข้อมูล</td></tr>'; return; } const canWrite = currentUser.role !== 'Employee'; const canDelete = currentUser.role === 'Admin'; sortedContracts.forEach(c => { const status = getStatus(c.endDate); const actionButtons = `<td class="text-end"> <button class="btn btn-sm btn-outline-primary py-0 px-1 btn-edit-contract" data-branch-id="${c.branchId}" title="แก้ไข"><i class="material-icons" style="pointer-events: none;">edit</i></button> ${canDelete ? `<button class="btn btn-sm btn-outline-danger py-0 px-1 btn-delete-contract" data-branch-id="${c.branchId}" title="ลบ"><i class="material-icons" style="pointer-events: none;">delete</i></button>` : ''} </td>`; const row = `<tr><td>${c.branchId||''}</td><td>${c.name||''}</td><td>${c.district||''}</td><td>${formatThaiDate(c.startDate)}</td><td>${formatThaiDate(c.endDate)}</td><td><span class="status-badge ${status.class}">${status.text}</span></td>${canWrite ? actionButtons : ''}</tr>`; tableBody.insertAdjacentHTML('beforeend', row); }); }
            function renderUsersTable(users) { const sortedUsers = [...users].sort((a, b) => { const valA = a[userSort.key] ? a[userSort.key].toLowerCase() : ''; const valB = b[userSort.key] ? b[userSort.key].toLowerCase() : ''; if (valA < valB) return userSort.order === 'asc' ? -1 : 1; if (valA > valB) return userSort.order === 'asc' ? 1 : -1; return 0; }); const tableBody = document.getElementById('users-table-body'); tableBody.innerHTML = ''; if (sortedUsers.length === 0) { tableBody.innerHTML = '<tr><td colspan="5" class="text-center">ไม่พบข้อมูล</td></tr>'; return; } sortedUsers.forEach(u => { const actionButtons = `<td class="text-end"> <button class="btn btn-sm btn-outline-primary py-0 px-1 btn-edit-user" data-user-email="${u.email}" title="แก้ไข"><i class="material-icons" style="pointer-events: none;">manage_accounts</i></button> <button class="btn btn-sm btn-outline-danger py-0 px-1 btn-delete-user" data-user-email="${u.email}" title="ลบ"><i class="material-icons" style="pointer-events: none;">delete_forever</i></button> </td>`; const row = `<tr><td>${u.email}</td><td>${u.name}</td><td>${u.role}</td><td>${u.permissionArea}</td>${actionButtons}</tr>`; tableBody.insertAdjacentHTML('beforeend', row); }); }
            function renderLogsTable(logs) { const sortedLogs = [...logs].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); const tableBody = document.getElementById('logs-table-body'); tableBody.innerHTML = ''; if (sortedLogs.length === 0) { tableBody.innerHTML = '<tr><td colspan="4" class="text-center">ไม่พบข้อมูล</td></tr>'; return; } sortedLogs.forEach(log => { const formattedTimestamp = new Date(log.timestamp).toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'medium' }); const row = `<tr><td>${formattedTimestamp}</td><td>${log.user}</td><td>${log.activity}</td><td>${log.details}</td></tr>`; tableBody.insertAdjacentHTML('beforeend', row); }); }
            
            // Filtering and Sorting
            function applyContractFilters() { const searchTerm = document.getElementById('contract-search-input').value.toLowerCase(); const statusFilter = document.getElementById('contract-status-filter').value; const startDate = document.getElementById('contract-start-date').value; const endDate = document.getElementById('contract-end-date').value; let filteredContracts = allContracts.filter(c => { const matchesSearch = !searchTerm || (c.branchId && c.branchId.toLowerCase().includes(searchTerm)) || (c.name && c.name.toLowerCase().includes(searchTerm)) || (c.district && c.district.toLowerCase().includes(searchTerm)); const matchesStatus = !statusFilter || getStatus(c.endDate).class === statusFilter; const contractEndDate = c.endDate ? new Date(c.endDate) : null; const matchesStartDate = !startDate || (contractEndDate && contractEndDate >= new Date(startDate)); const matchesEndDate = !endDate || (contractEndDate && contractEndDate <= new Date(endDate)); return matchesSearch && matchesStatus && matchesStartDate && matchesEndDate; }); renderContractsTable(filteredContracts); }
            function applyUserFilters() { const searchTerm = document.getElementById('user-search-input').value.toLowerCase(); const roleFilter = document.getElementById('user-role-filter').value; let filteredUsers = allUsers.filter(u => (!searchTerm || (u.email && u.email.toLowerCase().includes(searchTerm)) || (u.name && u.name.toLowerCase().includes(searchTerm))) && (!roleFilter || u.role === roleFilter)); renderUsersTable(filteredUsers); }
            function applyLogFilters() { const searchTerm = document.getElementById('log-search-input').value.toLowerCase(); const startDate = document.getElementById('log-start-date').value; const endDate = document.getElementById('log-end-date').value; const startDateTime = startDate ? new Date(startDate).setHours(0,0,0,0) : 0; const endDateTime = endDate ? new Date(endDate).setHours(23,59,59,999) : Infinity; let filteredLogs = allLogs.filter(log => { const logTime = new Date(log.timestamp).getTime(); return (!searchTerm || (log.user && log.user.toLowerCase().includes(searchTerm)) || (log.activity && log.activity.toLowerCase().includes(searchTerm)) || (log.details && log.details.toLowerCase().includes(searchTerm))) && (logTime >= startDateTime && logTime <= endDateTime); }); renderLogsTable(filteredLogs); }
            function handleSort(event, page) { const header = event.target.closest('.sortable'); if (!header) return; const newKey = header.dataset.sort; let sortState, renderFunction, contentId; if (page === 'contract') { sortState = contractSort; renderFunction = applyContractFilters; contentId = '#contracts-content'; } else if (page === 'user') { sortState = userSort; renderFunction = applyUserFilters; contentId = '#users-content'; } else { return; } if (sortState.key === newKey) { sortState.order = sortState.order === 'asc' ? 'desc' : 'asc'; } else { sortState.key = newKey; sortState.order = 'asc'; } document.querySelectorAll(`${contentId} .sortable`).forEach(th => { th.classList.remove('asc', 'desc'); th.querySelector('.sort-icon').textContent = 'unfold_more'; }); header.classList.add(sortState.order); header.querySelector('.sort-icon').textContent = sortState.order === 'asc' ? 'expand_less' : 'expand_more'; renderFunction(); }

            // Modals
            function openContractModal (branchId = null) { const form = document.getElementById('contract-form'); form.reset(); const modalTitle = document.getElementById('contractModalLabel'); const branchIdInput = document.getElementById('form-contract-branchId'); if (branchId) { modalTitle.textContent = 'แก้ไขข้อมูลสัญญา'; branchIdInput.readOnly = true; const contract = allContracts.find(c => c.branchId === branchId); if (contract) { Object.keys(contract).forEach(key => { const el = document.getElementById(`form-contract-${key()}`); if(el) el.value = contract[key]; }); } } else { modalTitle.textContent = 'เพิ่มสัญญาใหม่'; branchIdInput.readOnly = false; document.getElementById('form-contract-regional').value = 'P026'; } contractModal.show(); }
            function openUserModal(userEmail = null) { const form = document.getElementById('user-form'); form.reset(); const modalTitle = document.getElementById('userModalLabel'); const emailInput = document.getElementById('form-user-email'); const passwordInput = document.getElementById('form-user-password'); if (userEmail) { modalTitle.textContent = 'แก้ไขข้อมูลผู้ใช้งาน'; emailInput.readOnly = true; passwordInput.placeholder = "เว้นว่างไว้หากไม่ต้องการเปลี่ยน"; passwordInput.required = false; const user = allUsers.find(u => u.email === userEmail); if (user) { Object.keys(user).forEach(key => { const el = document.getElementById(`form-user-${key()}`); if(el) el.value = user[key]; }); } } else { modalTitle.textContent = 'เพิ่มผู้ใช้ใหม่'; emailInput.readOnly = false; passwordInput.placeholder = "กำหนดรหัสผ่าน"; passwordInput.required = true; } userModal.show(); }
            
            // CRUD Actions
            function handleSaveContract() { const contractData = { branchId: document.getElementById('form-contract-branchId').value, name: document.getElementById('form-contract-name').value, regional: document.getElementById('form-contract-regional').value, district: document.getElementById('form-contract-district').value, monthlyRent: document.getElementById('form-contract-monthlyRent').value, startDate: document.getElementById('form-contract-startDate').value, endDate: document.getElementById('form-contract-endDate').value }; if (!contractData.branchId || !contractData.name || !contractData.endDate) { showErrorAlert('กรุณากรอกข้อมูลสำคัญให้ครบถ้วน'); return; } postDataToGAS('saveContract', contractData).then(() => { showSuccessToast('บันทึกข้อมูลสำเร็จ!'); contractModal.hide(); loadContractsData(); loadDashboardData(); }).catch(showErrorAlert); }
            function handleDeleteContract(branchId) { const contract = allContracts.find(c => c.branchId === branchId); showConfirmDialog('ยืนยันการลบ', `ต้องการลบสัญญาของสาขา "${contract ? contract.name : branchId}"?`).then(result => { if (result.isConfirmed) { postDataToGAS('deleteContract', { branchId }).then(() => { showSuccessToast('ลบข้อมูลสำเร็จ!'); loadContractsData(); loadDashboardData(); }).catch(showErrorAlert); } }); }
            function handleSaveUser() { const userData = { email: document.getElementById('form-user-email').value, name: document.getElementById('form-user-name').value, password: document.getElementById('form-user-password').value, role: document.getElementById('form-user-role').value, permissionArea: document.getElementById('form-user-permissionArea').value }; if (!userData.email || !userData.name) { showErrorAlert('กรุณากรอก Email และ ชื่อ'); return; } if (!document.getElementById('form-user-email').readOnly && !userData.password) { showErrorAlert('กรุณากำหนดรหัสผ่านสำหรับผู้ใช้ใหม่'); return; } postDataToGAS('saveUser', userData).then(() => { showSuccessToast('บันทึกข้อมูลสำเร็จ!'); userModal.hide(); loadUsersData(); }).catch(showErrorAlert); }
            function handleDeleteUser(userEmail) { const user = allUsers.find(u => u.email === userEmail); showConfirmDialog('ยืนยันการลบ', `ต้องการลบผู้ใช้ "${user ? user.name : userEmail}"?`).then(result => { if (result.isConfirmed) { postDataToGAS('deleteUser', { email: userEmail }).then(() => { showSuccessToast('ลบผู้ใช้สำเร็จ!'); loadUsersData(); }).catch(showErrorAlert); } }); }

            // --- App Initialization ---
            function initializeApp() {
                contractModal = new bootstrap.Modal(document.getElementById('contract-modal'));
                userModal = new bootstrap.Modal(document.getElementById('user-modal'));
                
                document.getElementById('login-button').addEventListener('click', handleLogin);
                document.getElementById('password').addEventListener('keyup', e => { if (e.key === 'Enter') handleLogin(); });
                logoutButton.addEventListener('click', handleLogout);
                
                navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const pageId = link.getAttribute('href').substring(1) + '-content'; navLinks.forEach(l => l.classList.remove('active')); link.classList.add('active'); showPage(pageId); }); });

                document.getElementById('contracts-table-body').addEventListener('click', (e) => { const editBtn = e.target.closest('.btn-edit-contract'); const deleteBtn = e.target.closest('.btn-delete-contract'); if (editBtn) openContractModal(editBtn.dataset.branchId); if (deleteBtn) handleDeleteContract(deleteBtn.dataset.branchId); });
                document.getElementById('users-table-body').addEventListener('click', (e) => { const editBtn = e.target.closest('.btn-edit-user'); const deleteBtn = e.target.closest('.btn-delete-user'); if (editBtn) openUserModal(editBtn.dataset.userEmail); if (deleteBtn) handleDeleteUser(deleteBtn.dataset.userEmail); });
                
                document.querySelectorAll('#contracts-content .sortable').forEach(th => th.addEventListener('click', e => handleSort(e, 'contract')));
                document.querySelectorAll('#users-content .sortable').forEach(th => th.addEventListener('click', e => handleSort(e, 'user')));
                ['contract-search-input', 'contract-status-filter', 'contract-start-date', 'contract-end-date'].forEach(id => document.getElementById(id).addEventListener('input', applyContractFilters));
                document.getElementById('contract-clear-filter-btn').addEventListener('click', () => { ['contract-search-input', 'contract-status-filter', 'contract-start-date', 'contract-end-date'].forEach(id => document.getElementById(id).value = ''); applyContractFilters(); });
                ['user-search-input', 'user-role-filter'].forEach(id => document.getElementById(id).addEventListener('input', applyUserFilters));
                ['log-search-input', 'log-start-date', 'log-end-date'].forEach(id => document.getElementById(id).addEventListener('input', applyLogFilters));
                document.getElementById('log-clear-filter-btn').addEventListener('click', () => { ['log-search-input', 'log-start-date', 'log-end-date'].forEach(id => document.getElementById(id).value = ''); applyLogFilters(); });
                
                document.getElementById('card-total').addEventListener('click', () => navigateToContractsAndFilter(''));
                document.getElementById('card-expiring').addEventListener('click', () => navigateToContractsAndFilter('status-warning'));
                document.getElementById('card-expired').addEventListener('click', () => navigateToContractsAndFilter('status-expired'));
                
                document.getElementById('add-contract-btn').addEventListener('click', () => openContractModal());
                document.getElementById('save-contract-button').addEventListener('click', handleSaveContract);
                document.getElementById('add-user-btn').addEventListener('click', () => openUserModal());
                document.getElementById('save-user-button').addEventListener('click', handleSaveUser);
                
                checkSession();
            }
            
            initializeApp();
        });
    </script>
</body>

</html>
